<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡é›™å¼•æ“å„€è¡¨æ¿ v3.5 (KDJ æˆ°ç•¥ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Microsoft JhengHei', sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; }
        .input-field { background-color: #0f172a; border: 1px solid #475569; color: white; }
        .btn-primary { background-color: #06b6d4; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #0891b2; }
        .text-profit { color: #ef4444; } 
        .text-loss { color: #22c55e; }
        .buy-point { color: #facc15; font-weight: bold; }
        .industry-header { background: #334155; color: #94a3b8; font-size: 0.75rem; font-weight: bold; padding: 4px 12px; }
        
        /* KDJ ç‹€æ…‹æ¨™ç±¤ */
        .kdj-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .kdj-overbought { background-color: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid #ef4444; } /* ç´…è‰²è¶…è²· */
        .kdj-oversold { background-color: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid #22c55e; } /* ç¶ è‰²è¶…è³£ */
        .kdj-neutral { background-color: rgba(148, 163, 184, 0.2); color: #cbd5e1; } /* ç°è‰²å¾˜å¾Š */

        /* 499 å¤§å–®ç‰¹æ•ˆ */
        .big-order-row { animation: flash 2s infinite; }
        @keyframes flash {
            0% { background-color: rgba(239, 68, 68, 0.1); }
            50% { background-color: rgba(239, 68, 68, 0.3); }
            100% { background-color: rgba(239, 68, 68, 0.1); }
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- é ‚éƒ¨å°èˆª -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-cyan-400">ğŸš€ å°è‚¡é›™å¼•æ“å„€è¡¨æ¿</h1>
            <p class="text-slate-400 text-sm mt-1">v3.5 KDJ æˆ°ç•¥ç‰ˆ | Fugle + FinMind</p>
        </div>
        <div class="text-right">
            <div id="updateTime" class="text-xs text-slate-500">æ›´æ–°ä¸­...</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- å·¦å´ï¼šå€‹è‚¡è¨ºæ–· -->
        <div class="lg:col-span-1 space-y-6">
            <div class="card p-5">
                <h2 class="text-xl font-bold mb-4 border-l-4 border-cyan-400 pl-3">ğŸ” å€‹è‚¡è¨ºæ–·</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="stockInput" placeholder="ä»£ç¢¼ (å¦‚ 2330)" class="input-field flex-1 px-4 py-2 rounded-lg focus:outline-none focus:border-cyan-400">
                    <button onclick="analyzeStock()" class="btn-primary px-6 py-2 rounded-lg font-bold">åˆ†æ</button>
                </div>
                
                <div id="analysisResult" class="hidden space-y-4">
                    <div class="flex justify-between items-end border-b border-slate-700 pb-3">
                        <div>
                            <h3 id="stockNameDisplay" class="text-2xl font-bold text-white">--</h3>
                            <span id="kdjStatusBadge" class="kdj-tag kdj-neutral">KDJ è¨ˆç®—ä¸­</span>
                        </div>
                        <div class="text-right">
                            <div id="currentPrice" class="text-4xl font-bold text-white">--</div>
                            <div id="priceChange" class="text-base font-bold text-slate-400">--</div>
                        </div>
                    </div>

                    <!-- KDJ æŒ‡æ¨™å¡ç‰‡ -->
                    <div class="grid grid-cols-3 gap-2 text-center bg-slate-800 p-2 rounded border border-slate-700">
                        <div>
                            <div class="text-xs text-slate-500">Kå€¼</div>
                            <div id="kVal" class="font-mono font-bold text-white">--</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-500">Då€¼</div>
                            <div id="dVal" class="font-mono font-bold text-white">--</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-500">Jå€¼</div>
                            <div id="jVal" class="font-mono font-bold text-white">--</div>
                        </div>
                    </div>
                    <div id="kdjAdvice" class="text-xs text-center text-slate-400 italic">ç­‰å¾…åˆ†æ...</div>

                    <div class="bg-slate-800/80 p-3 rounded-lg border border-yellow-600/30 mt-2">
                        <div class="flex justify-between items-center text-sm mb-1">
                            <span class="text-slate-400">ğŸ¯ ç³»çµ±å»ºè­°è²·é»</span>
                            <span class="text-xs text-yellow-500 bg-yellow-900/20 px-2 rounded">æ”¯æ’ç®—æ³•</span>
                        </div>
                        <div class="flex justify-between items-end">
                            <span id="recommendBuy" class="text-2xl font-mono text-yellow-400 font-bold">--</span>
                            <span id="diffText" class="text-xs text-slate-400">è·ç¾åƒ¹ --%</span>
                        </div>
                    </div>
                    
                    <button onclick="addToPortfolio()" class="w-full bg-cyan-700 hover:bg-cyan-600 text-white py-3 rounded-lg mt-4 transition shadow-lg">
                        + åŠ å…¥æŒå€‰
                    </button>
                </div>
            </div>

            <!-- ğŸ“‹ ç”¢æ¥­è§€å¯Ÿåå–® (å« KDJ ç‹€æ…‹) -->
            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-yellow-400 pl-3">ğŸ“‹ ç”¢æ¥­ KDJ æƒæ</h2>
                    <button onclick="refreshWatchlist()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-slate-300">ğŸ”„</button>
                </div>
                <div class="overflow-x-auto h-[500px] pr-1">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800 sticky top-0 z-10">
                            <tr>
                                <th class="px-2 py-2">è‚¡å</th>
                                <th class="px-2 py-2 text-right">ç¾åƒ¹</th>
                                <th class="px-2 py-2 text-center">KDJç‹€æ…‹</th>
                                <th class="px-2 py-2 text-right">è²·é»</th>
                            </tr>
                        </thead>
                        <tbody id="watchlistBody" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼š499é›·é” & æŒå€‰ -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- ğŸ”¥ 499 å¤§æˆ¶é›·é” -->
            <div class="card p-5 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-red-500/10 rounded-full blur-xl -mr-10 -mt-10 pointer-events-none"></div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-red-500 pl-3 flex items-center">
                        ğŸ“¡ 499 å¤§æˆ¶é›·é” 
                        <span class="ml-2 text-xs bg-red-900 text-red-300 px-2 py-0.5 rounded animate-pulse">LIVE</span>
                    </h2>
                    <button onclick="scanBigOrders()" class="text-xs bg-red-900/50 hover:bg-red-900 text-white px-3 py-1 rounded border border-red-700">ğŸš€ æƒæ</button>
                </div>
                
                <div class="overflow-x-auto max-h-64 bg-black/20 rounded-lg border border-slate-700/50">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800 sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3">æ™‚é–“</th>
                                <th class="px-4 py-3">è‚¡ç¥¨</th>
                                <th class="px-4 py-3 text-right">å¤§å–® (å¼µ)</th>
                                <th class="px-4 py-3 text-right">æˆäº¤åƒ¹</th>
                                <th class="px-4 py-3 text-right">é‡‘é¡ (è¬)</th>
                            </tr>
                        </thead>
                        <tbody id="bigOrderBody" class="divide-y divide-slate-700">
                            <tr><td colspan="5" class="text-center py-12 text-slate-500">ç­‰å¾… 499 å¤§å–®è¨Šè™Ÿ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æŒå€‰ç®¡ç† -->
            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-purple-400 pl-3">ğŸ’¼ æŒå€‰æç›Š</h2>
                    <span id="totalProfit" class="text-2xl font-bold text-white">0</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800/80">
                            <tr>
                                <th class="px-4 py-3">è‚¡ç¥¨</th>
                                <th class="px-4 py-3 text-right">æˆæœ¬</th>
                                <th class="px-4 py-3 text-right">ç¾åƒ¹</th>
                                <th class="px-4 py-3 text-right">åº«å­˜</th>
                                <th class="px-4 py-3 text-right">æç›Š</th>
                                <th class="px-4 py-3 text-center">åˆªé™¤</th>
                            </tr>
                        </thead>
                        <tbody id="portfolioBody" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”‘ API è¨­å®š
        const FUGLE_KEY = "OGNiYzc2YmQtMzdjYS00NTJkLWI1ZGUtNjY1ODRhNTMwNTAxIDhlMTRiMDVkLTk0NzItNDUzMi05NjY2LTkzYjlhMTQ5NzBjMw==";
        const FINMIND_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNS0xMS0yNyAxMjoyOToyOSIsInVzZXJfaWQiOiJMSU5QRyIsImlwIjoiMS4xNzAuMTE0LjIwIn0.SyyVMOX2eF6uNVO3EZpkRylFrQqFFXjH1PJcM5oFQt0";

        // ğŸ­ ç”¢æ¥­åˆ†é¡æ¸…å–®
        const INDUSTRY_LIST = {
            'åŠå°é«”': ['2330', '2454', '2303', '3034', '3711'],
            'AIä¼ºæœå™¨': ['2382', '3231', '6669', '2356', '2301'],
            'é›»è…¦å‘¨é‚Š': ['2317', '2357', '2324', '3017'],
            'èˆªé‹': ['2603', '2609', '2615', '2618'],
            'é‡‘è': ['2881', '2882', '2891', '2886', '2884'],
            'é‡é›»ç¶ èƒ½': ['1513', '1519', '1514', '1504']
        };
        const SCAN_POOL = Object.values(INDUSTRY_LIST).flat();
        
        let currentStock = null;
        let portfolio = JSON.parse(localStorage.getItem('pro_portfolio_v3')) || [];

        window.onload = () => {
            renderPortfolio();
            refreshWatchlist();
            setInterval(updatePortfolioPrices, 60000);
            setInterval(scanBigOrders, 15000); 
        };

        // ğŸ§  KDJ è¨ˆç®—æ ¸å¿ƒ (RSV -> K -> D -> J)
        function calculateKDJ(historyData) {
            if (historyData.length < 9) return null; // è³‡æ–™ä¸è¶³

            let k = 50, d = 50;
            const result = [];

            // ç°¡å–®è¨ˆç®—æœ€è¿‘ä¸€å¤©çš„ KDJ (å¯¦å‹™ä¸Šéœ€éè¿´è¨ˆç®—ï¼Œé€™è£¡ç°¡åŒ–ç‚ºè¨ˆç®—æœ€å¾Œä¸€å¤©)
            // æ­£ç¢ºåšæ³•æ‡‰å¾ç¬¬9å¤©é–‹å§‹ä¸€è·¯ç®—åˆ°ä»Šå¤©ï¼Œç‚ºäº†æ•ˆèƒ½æˆ‘å€‘å–æœ€è¿‘ 9 å¤©è¨ˆç®—ä¸€æ¬¡ RSV
            // é€™è£¡ç‚ºäº†æº–ç¢ºåº¦ï¼Œæˆ‘å€‘ç”¨éè¿´æ–¹å¼ç®—æœ€å¾Œ 5 å¤©
            
            // å…ˆåˆå§‹åŒ– K, D
            let k_prev = 50, d_prev = 50;
            
            // æˆ‘å€‘åªéœ€è¦ç®—æœ€å¾Œä¸€å¤©çš„å€¼ï¼Œä½†ç‚ºäº†å¹³æ»‘ï¼Œå»ºè­°å¾å€’æ•¸ç¬¬ N å¤©é–‹å§‹è·‘
            const startIdx = Math.max(0, historyData.length - 20); 

            for (let i = startIdx; i < historyData.length; i++) {
                // æ‰¾æœ€è¿‘ 9 å¤© (åŒ…å«ä»Šå¤©) çš„æœ€é«˜ High å’Œæœ€ä½ Low
                const lookback = Math.max(0, i - 8);
                const slice = historyData.slice(lookback, i + 1);
                
                const close = historyData[i].close;
                const high9 = Math.max(...slice.map(d => d.max));
                const low9 = Math.min(...slice.map(d => d.min));
                
                let rsv = 50;
                if (high9 !== low9) {
                    rsv = ((close - low9) / (high9 - low9)) * 100;
                }
                
                // K = 2/3 * K_prev + 1/3 * RSV
                const k_curr = (2/3) * k_prev + (1/3) * rsv;
                // D = 2/3 * D_prev + 1/3 * K
                const d_curr = (2/3) * d_prev + (1/3) * k_curr;
                // J = 3K - 2D
                const j_curr = 3 * k_curr - 2 * d_curr;
                
                k_prev = k_curr;
                d_prev = d_curr;
                
                if (i === historyData.length - 1) {
                    return { k: k_curr, d: d_curr, j: j_curr };
                }
            }
            return { k: 50, d: 50, j: 50 };
        }

        // ğŸ”„ ç”¢æ¥­è§€å¯Ÿåå–®åˆ·æ–° (å« KDJ ç‹€æ…‹)
        async function refreshWatchlist() {
            const tbody = document.getElementById('watchlistBody');
            tbody.innerHTML = '';
            
            for (const [industryName, stocks] of Object.entries(INDUSTRY_LIST)) {
                const headerRow = `<tr><td colspan="4" class="industry-header sticky top-8 z-0">ğŸ“‚ ${industryName}</td></tr>`;
                tbody.innerHTML += headerRow;

                for (const id of stocks) {
                    try {
                        const quote = await fetchFugleQuote(id);
                        const history = await fetchFinMindHistory(id);
                        const kdj = calculateKDJ(history);
                        
                        let kdjBadge = '<span class="text-slate-500 text-xs">-</span>';
                        if (kdj) {
                            const k = kdj.k;
                            if (k > 80) kdjBadge = '<span class="kdj-tag kdj-overbought">è¶…è²·(>80)</span>';
                            else if (k < 20) kdjBadge = '<span class="kdj-tag kdj-oversold">è¶…è³£(<20)</span>';
                            else kdjBadge = '<span class="kdj-tag kdj-neutral">å¾˜å¾Šå€</span>';
                        }

                        let buyPoint = quote.lastPrice * 0.9;
                        if(history.length >= 5) buyPoint = Math.min(...history.slice(-5).map(d => d.min));
                        
                        tbody.innerHTML += `
                            <tr class="hover:bg-slate-700 cursor-pointer border-b border-slate-700/50" onclick="analyzeStock('${id}')">
                                <td class="px-2 py-2 font-bold text-white">${quote.name} <span class="text-[10px] text-slate-500">${id}</span></td>
                                <td class="px-2 py-2 text-right text-slate-300">${quote.lastPrice}</td>
                                <td class="px-2 py-2 text-center">${kdjBadge}</td>
                                <td class="px-2 py-2 text-right font-mono buy-point text-xs">${buyPoint.toFixed(1)}</td>
                            </tr>
                        `;
                    } catch(e){}
                }
            }
        }

        // ğŸ› ï¸ æ ¸å¿ƒåˆ†æ (åŠ å…¥ KDJ åˆ¤æ–·)
        async function analyzeStock(inputId = null) {
            const stockId = inputId || document.getElementById('stockInput').value.trim();
            if (!stockId) return alert("è«‹è¼¸å…¥ä»£ç¢¼");
            const btn = document.querySelector('button[onclick="analyzeStock()"]');
            if(btn) btn.innerText = "...";
            try {
                const [fugleData, historyData] = await Promise.all([fetchFugleQuote(stockId), fetchFinMindHistory(stockId)]);
                const kdj = calculateKDJ(historyData);
                
                let buyPoint = 0, score = 50;
                if (historyData.length >= 5) {
                    buyPoint = Math.min(...historyData.slice(-5).map(d => d.min));
                } else { buyPoint = fugleData.lastPrice * 0.95; }

                currentStock = { id: stockId, name: fugleData.name, price: fugleData.lastPrice, buyPoint: buyPoint, score: score, kdj: kdj };
                updateAnalysisUI(currentStock, fugleData);
            } catch (e) { console.error(e); alert("åˆ†æå¤±æ•—"); } 
            finally { if(btn) btn.innerText = "åˆ†æ"; }
        }

        function updateAnalysisUI(stock, fugle) {
            document.getElementById('analysisResult').classList.remove('hidden');
            document.getElementById('stockNameDisplay').innerText = `${stock.name} (${stock.id})`;
            const color = fugle.change >= 0 ? 'text-profit' : 'text-loss';
            document.getElementById('currentPrice').innerText = stock.price;
            document.getElementById('currentPrice').className = `text-4xl font-bold ${color}`;
            document.getElementById('priceChange').innerText = `${fugle.change} (${(fugle.changePercent*100).toFixed(2)}%)`;
            document.getElementById('priceChange').className = `text-base font-bold ${color}`;
            
            const diff = ((stock.price - stock.buyPoint) / stock.buyPoint * 100).toFixed(1);
            document.getElementById('recommendBuy').innerText = stock.buyPoint.toFixed(1);
            document.getElementById('diffText').innerText = `è·ç¾åƒ¹ ${diff}%`;

            // KDJ UI
            const badge = document.getElementById('kdjStatusBadge');
            const advice = document.getElementById('kdjAdvice');
            
            if (stock.kdj) {
                const { k, d, j } = stock.kdj;
                document.getElementById('kVal').innerText = k.toFixed(1);
                document.getElementById('dVal').innerText = d.toFixed(1);
                document.getElementById('jVal').innerText = j.toFixed(1);
                
                if (k > 80) {
                    badge.className = "kdj-tag kdj-overbought";
                    badge.innerText = "âš ï¸ è¶…è²· (>80)";
                    advice.innerText = "è¡Œæƒ…éç†±ï¼ŒçŸ­ç·šæå›æª”ï¼Œå‹¿è¿½é«˜ï¼";
                } else if (k < 20) {
                    badge.className = "kdj-tag kdj-oversold";
                    badge.innerText = "ğŸ’ è¶…è³£ (<20)";
                    advice.innerText = "è¡Œæƒ…è¶…è·Œï¼ŒçŸ­ç·šåå½ˆæ©Ÿæœƒå¤§ï¼Œå¯ç•™æ„ï¼";
                } else {
                    badge.className = "kdj-tag kdj-neutral";
                    badge.innerText = "å¾˜å¾Šå€ (20-80)";
                    advice.innerText = "è¶¨å‹¢åˆç†ï¼Œå¯æ–¼å€é–“å…§ä½è²·é«˜è³£ã€‚";
                }
            } else {
                advice.innerText = "æ­·å²è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•è¨ˆç®— KDJ";
            }
        }

        // 499, æƒæ, API å°è£, æŒå€‰ç­‰åŠŸèƒ½ç¶­æŒ v3.4 ä¸è®Š
        async function scanBigOrders() {
            const tbody = document.getElementById('bigOrderBody');
            if(tbody.innerHTML.includes('ç­‰å¾…')) tbody.innerHTML = '';
            const randomTargets = SCAN_POOL.sort(() => 0.5 - Math.random()).slice(0, 3);
            for (const id of randomTargets) {
                try {
                    const res = await fetch(`https://api.fugle.tw/marketdata/v1.0/stock/intraday/quote/${id}`, { headers: { "X-API-KEY": FUGLE_KEY } });
                    const json = await res.json();
                    const trade = json.lastTrade;
                    if (trade && trade.unit >= 100) { // æ¸¬è©¦ç”¨100
                        const time = new Date(json.lastUpdated / 1000).toLocaleTimeString();
                        const amount = Math.round((trade.price * trade.unit * 1000) / 10000);
                        const rowHTML = `
                            <tr class="big-order-row border-b border-slate-700 cursor-pointer hover:bg-slate-700" onclick="analyzeStock('${id}')">
                                <td class="px-4 py-3 text-slate-400 font-mono text-xs">${time}</td>
                                <td class="px-4 py-3 font-bold text-white">${json.name}</td>
                                <td class="px-4 py-3 text-right text-yellow-400 font-bold text-lg">âš¡ ${trade.unit}</td>
                                <td class="px-4 py-3 text-right text-white">${trade.price}</td>
                                <td class="px-4 py-3 text-right text-slate-400">${amount.toLocaleString()}</td>
                            </tr>`;
                        tbody.insertAdjacentHTML('afterbegin', rowHTML);
                        if(tbody.rows.length > 50) tbody.deleteRow(-1);
                    }
                } catch(e) {}
            }
        }

        async function fetchFugleQuote(id) {
            const res = await fetch(`https://api.fugle.tw/marketdata/v1.0/stock/intraday/quote/${id}`, { headers: { "X-API-KEY": FUGLE_KEY } });
            return await res.json();
        }
        async function fetchFinMindHistory(id) {
            const startDate = new Date(Date.now() - 40 * 86400000).toISOString().split('T')[0]; // æŠ“40å¤©ä»¥ç®—KDJ
            const res = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=${startDate}&token=${FINMIND_TOKEN}`);
            const json = await res.json();
            return json.data || [];
        }
        function addToPortfolio() {
            if (!currentStock) return;
            const qty = prompt("è¼¸å…¥å¼µæ•¸:", "1");
            if(!qty) return;
            portfolio.push({ id: currentStock.id, name: currentStock.name, cost: currentStock.price, qty: parseFloat(qty), curr: currentStock.price });
            saveAndRender();
        }
        function renderPortfolio() {
            const tbody = document.getElementById('portfolioBody');
            let totalPnL = 0;
            tbody.innerHTML = '';
            portfolio.forEach((p, i) => {
                const profit = (p.curr - p.cost) * p.qty * 1000;
                totalPnL += profit;
                const color = profit >= 0 ? 'text-profit' : 'text-loss';
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-800/50">
                        <td class="px-4 py-3 font-bold text-white">${p.name}</td>
                        <td class="px-4 py-3 text-right">${p.cost}</td>
                        <td class="px-4 py-3 text-right text-white">${p.curr}</td>
                        <td class="px-4 py-3 text-right">${p.qty}</td>
                        <td class="px-4 py-3 text-right font-bold ${color}">${Math.round(profit)}</td>
                        <td class="px-4 py-3 text-center"><button onclick="removeP(${i})" class="text-red-400">âœ•</button></td>
                    </tr>`;
            });
            document.getElementById('totalProfit').innerText = Math.round(totalPnL).toLocaleString();
            document.getElementById('totalProfit').className = `text-2xl font-bold ${totalPnL >= 0 ? 'text-profit' : 'text-loss'}`;
        }
        function removeP(i) { portfolio.splice(i, 1); saveAndRender(); }
        function saveAndRender() { localStorage.setItem('pro_portfolio_v3', JSON.stringify(portfolio)); renderPortfolio(); }
        async function updatePortfolioPrices() {
            for(let p of portfolio) { try { const q = await fetchFugleQuote(p.id); if(q.lastPrice) p.curr = q.lastPrice; } catch(e){} }
            saveAndRender();
        }
    </script>
</body>
</html>
