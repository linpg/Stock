<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡é›™å¼•æ“å„€è¡¨æ¿ v5.14 (çœŸå¯¦å¤–è³‡ç±Œç¢¼ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Microsoft JhengHei', sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; }
        .input-field { background-color: #0f172a; border: 1px solid #475569; color: white; }
        .btn-primary { background-color: #06b6d4; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #0891b2; }
        .text-profit { color: #ef4444; } 
        .text-loss { color: #22c55e; }
        
        .category-btn { padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; cursor: pointer; transition: all 0.3s; border: 1px solid transparent; }
        .category-btn.active { background: linear-gradient(90deg, #7c3aed, #db2777); color: white; }
        .category-btn.inactive { background-color: #334155; color: #94a3b8; }
        .category-btn:hover { opacity: 0.8; }

        .status-hot { background: linear-gradient(90deg, #be185d, #db2777); color: white; }
        .status-foreign { background: linear-gradient(90deg, #7c3aed, #a855f7); color: white; font-weight: bold; }
        .status-volume { background: linear-gradient(90deg, #f59e0b, #d97706); color: white; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Modal -->
    <div id="addPortfolioModal" class="fixed inset-0 z-50 hidden flex items-center justify-center" style="background-color: rgba(0,0,0,0.8);">
        <div class="bg-slate-800 rounded-lg border border-slate-600 p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4">ğŸ“¥ åŠ å…¥æŒå€‰</h3>
            <div class="mb-4"><label class="block text-slate-400 text-sm mb-1">è‚¡ç¥¨åç¨±</label><input type="text" id="modalStockName" class="w-full bg-slate-700 text-white px-3 py-2 rounded border border-slate-600" disabled></div>
            <div class="mb-4"><label class="block text-slate-400 text-sm mb-1">æŒæœ‰å¼µæ•¸</label><input type="number" id="modalQty" class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-cyan-500" value="1"></div>
            <div class="mb-6"><label class="block text-slate-400 text-sm mb-1">è²·å…¥æˆæœ¬åƒ¹</label><input type="number" id="modalCost" class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-cyan-500"></div>
            <div class="flex justify-end gap-3"><button onclick="closeModal()" class="px-4 py-2 text-slate-300">å–æ¶ˆ</button><button onclick="confirmAddPortfolio()" class="px-6 py-2 bg-cyan-600 text-white rounded font-bold">ç¢ºèªåŠ å…¥</button></div>
        </div>
    </div>

    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-cyan-400">ğŸš€ å°è‚¡é›™å¼•æ“å„€è¡¨æ¿</h1>
            <p class="text-slate-400 text-sm mt-1">v5.13 çœŸå¯¦å¤–è³‡ç±Œç¢¼ç‰ˆ | æ‰€æœ‰æ•¸æ“š 100% çœŸå¯¦</p>
        </div>
        <div id="statusIndicator" class="text-xs text-yellow-400">ğŸ”„ åˆå§‹åŒ–ä¸­...</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- å·¦å´ -->
        <div class="lg:col-span-1 space-y-6">
            <!-- å€‹è‚¡è¨ºæ–· -->
            <div class="card p-5">
                <h2 class="text-xl font-bold mb-4 border-l-4 border-cyan-400 pl-3">ğŸ” å€‹è‚¡è¨ºæ–·</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="stockInput" placeholder="ä»£ç¢¼ (ä¾‹: 2330)" class="input-field flex-1 px-4 py-2 rounded-lg">
                    <button onclick="analyzeStock()" class="btn-primary px-6 py-2 rounded-lg font-bold">åˆ†æ</button>
                </div>
                <div id="analysisResult" class="hidden space-y-3">
                    <div><h3 id="stockNameDisplay" class="text-2xl font-bold text-white">--</h3></div>
                    <div class="flex justify-between"><span class="text-slate-400">ç¾åƒ¹</span><span id="currentPrice" class="text-2xl font-bold text-profit">--</span></div>
                    <div class="flex justify-between"><span class="text-slate-400">æ¼²è·Œ</span><span id="priceChange" class="font-bold text-profit">--</span></div>
                    <div class="grid grid-cols-3 gap-2 bg-slate-800 p-2 rounded">
                        <div class="text-center"><div class="text-xs text-slate-500">K</div><div id="kVal" class="font-bold">--</div></div>
                        <div class="text-center"><div class="text-xs text-slate-500">D</div><div id="dVal" class="font-bold">--</div></div>
                        <div class="text-center"><div class="text-xs text-slate-500">J</div><div id="jVal" class="font-bold">--</div></div>
                    </div>
                    <div><div class="text-sm text-slate-400">å»ºè­°è²·é»</div><div id="recommendBuy" class="text-xl font-bold text-yellow-400">--</div></div>
                    <button onclick="openAddModal()" class="w-full bg-cyan-700 text-white py-3 rounded-lg font-bold">+ åŠ å…¥æŒå€‰</button>
                </div>
            </div>

            <!-- ç›£æ§æ¨¡å¼ -->
            <div class="card p-5">
                <h2 class="text-xl font-bold mb-4 border-l-4 border-purple-500 pl-3">ğŸ“Š ç›£æ§æ¨¡å¼</h2>
                <div class="flex flex-col gap-2">
                    <button class="category-btn active" onclick="switchMode('foreign')">ğŸ”¥ å¤–è³‡è²·è¶…</button>
                    <button class="category-btn inactive" onclick="switchMode('strength')">ğŸ’ª å¼·å‹¢æ’å</button>
                    <button class="category-btn inactive" onclick="switchMode('volume')">ğŸ“ˆ é‡èƒ½çªç ´</button>
                </div>
            </div>

            <!-- é¡è‚¡éæ¿¾ -->
            <div class="card p-5">
                <h2 class="text-xl font-bold mb-4 border-l-4 border-pink-500 pl-3">ğŸ·ï¸ é¡è‚¡éæ¿¾</h2>
                <div class="flex flex-wrap gap-2">
                    <button class="category-btn active" onclick="switchCategory('all')">å…¨éƒ¨</button>
                    <button class="category-btn inactive" onclick="switchCategory('ai')">AI</button>
                    <button class="category-btn inactive" onclick="switchCategory('pcb')">PCB</button>
                    <button class="category-btn inactive" onclick="switchCategory('chip')">æ™¶ç‰‡</button>
                    <button class="category-btn inactive" onclick="switchCategory('cowos')">CoWoS</button>
                    <button class="category-btn inactive" onclick="switchCategory('ship')">èˆªé‹</button>
                    <button class="category-btn inactive" onclick="switchCategory('memory')">è¨˜æ†¶é«”</button>
                </div>
            </div>

            <!-- ç†±é–€è‚¡æ¦œ -->
            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-pink-500 pl-3" id="modeTitle">ğŸ”¥ å¤–è³‡è²·è¶…æ’å</h2>
                    <button onclick="scanMarket()" class="text-xs bg-pink-900 text-pink-100 px-3 py-1 rounded">åˆ·æ–°</button>
                </div>
                <div class="overflow-y-auto h-[500px]">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-slate-800 sticky top-0">
                            <tr><th class="px-2 py-2">#</th><th class="px-2 py-2">è‚¡å</th><th class="px-2 py-2 text-right">ç¾åƒ¹</th><th class="px-2 py-2 text-center" id="scoreHeader">å¤–è³‡</th></tr>
                        </thead>
                        <tbody id="watchlistBody" class="divide-y divide-slate-700">
                            <tr><td colspan="4" class="text-center py-8 text-slate-500">æƒæä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- å³å´ -->
        <div class="lg:col-span-2 space-y-6">
            <!-- å¤–è³‡å³æ™‚è²·é€² -->
            <div class="card p-5">
                <h2 class="text-xl font-bold border-l-4 border-purple-500 pl-3 mb-4">ğŸ¯ å¤–è³‡å³æ™‚è²·é€²</h2>
                <div class="overflow-y-auto max-h-64 bg-black/20 rounded-lg border border-slate-700/50">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-slate-800 sticky top-0">
                            <tr><th class="px-4 py-3">æ™‚é–“</th><th class="px-4 py-3">è‚¡ç¥¨</th><th class="px-4 py-3 text-right">å¤–è³‡(å¼µ)</th><th class="px-4 py-3 text-right">ç¾åƒ¹</th></tr>
                        </thead>
                        <tbody id="foreignBuyBody" class="divide-y divide-slate-700">
                            <tr><td colspan="4" class="text-center py-12 text-slate-500">ç­‰å¾…è¨Šè™Ÿ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æŒå€‰æç›Š -->
            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-purple-400 pl-3">ğŸ’¼ æŒå€‰æç›Š</h2>
                    <div class="flex gap-2">
                        <button onclick="exportData()" class="text-xs bg-blue-900 text-blue-300 px-3 py-1 rounded">å‚™ä»½</button>
                        <button onclick="importData()" class="text-xs bg-green-900 text-green-300 px-3 py-1 rounded">é‚„åŸ</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left text-slate-300">
                        <thead class="bg-slate-800/80">
                            <tr><th class="px-4 py-3">è‚¡ç¥¨</th><th class="px-4 py-3 text-right">æˆæœ¬</th><th class="px-4 py-3 text-right">ç¾åƒ¹</th><th class="px-4 py-3 text-right">åº«å­˜</th><th class="px-4 py-3 text-right">æç›Š</th><th class="px-4 py-3 text-center">åˆªé™¤</th></tr>
                        </thead>
                        <tbody id="portfolioBody" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
                <div class="text-right mt-4"><span class="text-sm text-slate-400">ç¸½æç›Š: </span><span id="totalProfit" class="text-2xl font-bold">0</span></div>
            </div>
        </div>
    </div>

    <script>
        const FUGLE_KEY = "OGNiYzc2YmQtMzdjYS00NTJkLWI1ZGUtNjY1ODRhNTMwNTAxIDhlMTRiMDVkLTk0NzItNDUzMi05NjY2LTkzYjlhMTQ5NzBjMw==";
        const FINMIND_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNS0xMS0yNyAxMjoyOToyOSIsInVzZXJfaWQiOiJMSU5QRyIsImlwIjoiMS4xNzAuMTE0LjIwIn0.SyyVMOX2eF6uNVO3EZpkRylFrQqFFXjH1PJcM5oFQt0";

        const LIQUID_STOCKS = ['2330', '2317', '2454', '2382', '3231', '6669', '2356', '3035', '3443', '3661', '2316', '4939', '5469', '8039', '5475', '5439', '3037', '2313', '1303', '2376', '3017', '3131', '6187', '4510', '1536', '2603', '2609', '2615', '2891', '2882', '2881', '2344', '4946', '4722', '2438', '1513', '1519', '1514', '6280', '3045', '2368', '3711', '4961', '2408', '3008', '3034', '5283', '8016', '3583', '2402', '2409', '2412', '2414', '2449', '2450', '2474', '2475', '2492', '2880', '3022', '3169', '3481', '3529', '3558', '3707', '4155', '4306', '4904', '4938', '5274', '5388', '5410', '5471', '5484', '6121', '6239', '6409', '6488', '6533', '8081', '8110', '8150', '8210', '9910', '9917', '9918', '9919', '9941'];

        const STOCK_CATEGORIES = {
            all: LIQUID_STOCKS,
            ai: ['2382', '3231', '6669', '2356', '2368', '3035', '3443', '2376'],
            pcb: ['2316', '4939', '5469', '8039', '5475', '5439', '3037', '2313', '1303'],
            chip: ['2330', '2454', '3661', '3443', '3035', '4722'],
            cowos: ['3131', '6187', '4510', '1536'],
            ship: ['2603', '2609', '2615'],
            memory: ['2344', '4946']
        };

        let marketData = [];
        let portfolio = JSON.parse(localStorage.getItem('pro_portfolio_v3')) || [];
        let currentMode = 'foreign';
        let currentCategory = 'all';
        let currentStock = null;

        window.onload = () => {
            renderPortfolio();
            scanMarket();
            setInterval(checkForeignBuys, 3000);
            setInterval(updatePortfolioPrices, 30000);
        };

        function switchMode(mode) {
            currentMode = mode;
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(b => { b.classList.remove('active'); b.classList.add('inactive'); });
            if (mode === 'foreign') buttons[0].classList.add('active');
            else if (mode === 'strength') buttons[1].classList.add('active');
            else if (mode === 'volume') buttons[2].classList.add('active');
            
            const titles = { foreign: 'ğŸ”¥ å¤–è³‡è²·è¶…æ’å', strength: 'ğŸ’ª ç¶œåˆå¼·å‹¢æ’å', volume: 'ğŸ“ˆ é‡èƒ½çªç ´æ’å' };
            document.getElementById('modeTitle').innerText = titles[mode];
            renderWatchlist();
        }

        function switchCategory(cat) {
            currentCategory = cat;
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach((b, i) => {
                if (i > 2) { b.classList.remove('active'); b.classList.add('inactive'); }
            });
            event.target.classList.add('active');
            event.target.classList.remove('inactive');
            renderWatchlist();
        }

        async function scanMarket() {
            document.getElementById('statusIndicator').innerText = 'ğŸ”„ æƒæä¸­...';
            marketData = [];
            const pool = STOCK_CATEGORIES[currentCategory] || LIQUID_STOCKS;

            await Promise.all(pool.map(async (id) => {
                try {
                    const quote = await fetchQuoteSafe(id);
                    if (!quote || quote.price === 0) return;

                    let history = [];
                    try { history = await fetchFinMindHistory(id); } catch(e) {}

                    // ğŸ”¥ å–å¾—çœŸå¯¦å¤–è³‡è²·è¶…æ•¸æ“š
                    let foreignBuy = 0;
                    try {
                        const today = new Date().toISOString().split('T')[0];
                        const instRes = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockInstitutionalInvestorsBuySell&data_id=${id}&start_date=${today}&token=${FINMIND_TOKEN}`);
                        const instJson = await instRes.json();
                        if (instJson.data && instJson.data.length > 0) {
                            const lastInst = instJson.data[instJson.data.length - 1];
                            foreignBuy = lastInst.Foreign_Investors_Buy_Sell || 0;
                        }
                    } catch(e) { console.log("ç„¡æ³•å–å¾— " + id + " çš„å¤–è³‡æ•¸æ“š"); }

                    const kdj = calculateKDJ(history);
                    const ma20 = history.length >= 20 ? history.slice(-20).reduce((a, b) => a + b.close, 0) / 20 : quote.price;
                    const priceChange = quote.change || 0;
                    
                    let volumeRatio = 1.0;
                    if (history.length >= 20) {
                        const ma20Vol = history.slice(-20).reduce((a, b) => a + b.volume, 0) / 20;
                        const todayVol = history.length > 0 ? history[history.length - 1].volume : 1;
                        volumeRatio = ma20Vol > 0 ? todayVol / ma20Vol : 1.0;
                    }

                    marketData.push({
                        id, name: quote.name, price: quote.price, change: priceChange, kdj,
                        foreignBuy: foreignBuy || 0,  // çœŸå¯¦å¤–è³‡è²·è¶…
                        strengthScore: priceChange * 10 + (foreignBuy / 100),
                        volumeRatio
                    });
                } catch(e) { console.log("æƒæ " + id + " å¤±æ•—"); }
            }));

            console.log("âœ… æƒæå®Œæˆï¼Œå–å¾— " + marketData.length + " æª”è‚¡ç¥¨");
            document.getElementById('statusIndicator').innerText = 'âœ… æ­£å¸¸é‹è¡Œ (' + marketData.length + ' æª”)';
            renderWatchlist();
        }

        function renderWatchlist() {
            const tbody = document.getElementById('watchlistBody');
            let sorted = [...marketData];
            
            if (currentMode === 'foreign') sorted.sort((a, b) => b.foreignBuy - a.foreignBuy);
            else if (currentMode === 'strength') sorted.sort((a, b) => b.strengthScore - a.strengthScore);
            else sorted.sort((a, b) => b.volumeRatio - a.volumeRatio);

            const pool = STOCK_CATEGORIES[currentCategory] || LIQUID_STOCKS;
            sorted = sorted.filter(s => pool.includes(s.id)).slice(0, 30);

            tbody.innerHTML = '';
            sorted.forEach((s, idx) => {
                let score = '';
                if (currentMode === 'foreign') score = s.foreignBuy + 'å¼µ';
                else if (currentMode === 'strength') score = s.strengthScore.toFixed(1);
                else score = s.volumeRatio.toFixed(2) + 'x';
                
                const color = s.change >= 0 ? 'text-profit' : 'text-loss';
               tbody.innerHTML += `<tr class="hover:bg-slate-700 cursor-pointer" onclick="analyzeStock('${s.id}')"><td class="px-2 py-2">${idx+1}</td><td class="px-2 py-2"><div class="font-bold">${s.name}</div><div class="text-[10px] text-slate-500">${s.id}</div></td><td class="px-2 py-2 text-right ${color}">${s.price.toFixed(2)}</td><td class="px-2 py-2 text-center text-purple-300">${score}</td></tr>`;
            });
        }

        async function checkForeignBuys() {
            const tbody = document.getElementById('foreignBuyBody');
            if (tbody.innerHTML.includes('ç­‰å¾…')) tbody.innerHTML = '';

            marketData.slice(0, 10).forEach(stock => {
                if (stock.foreignBuy > 50) {  // å¤–è³‡è²·è¶…è¶…é 50 å¼µ
                    const time = new Date().toLocaleTimeString();
                    if (!tbody.innerHTML.includes(stock.id)) {
                        tbody.insertAdjacentHTML('afterbegin', `<tr class="cursor-pointer hover:bg-slate-700 hover:bg-slate-600" onclick="analyzeStock('${stock.id}'); document.querySelector('#stockInput').value = '${stock.id}'; document.querySelector('#stockInput').scrollIntoView({behavior:'smooth'});" style="cursor: pointer;"><td class="px-4 py-3">${time}</td><td class="px-4 py-3"><div class="font-bold">${stock.name}</div><div class="text-[10px] text-slate-500">${stock.id}</div></td><td class="px-4 py-3 text-right text-purple-400">${stock.foreignBuy}</td><td class="px-4 py-3 text-right">${stock.price.toFixed(2)}</td></tr>`);
                        if (tbody.rows.length > 20) tbody.deleteRow(-1);
                    }
                }
            });
        }

        async function analyzeStock(id = null) {
            const stockId = id || document.getElementById('stockInput').value.trim();
            if (!stockId) return alert("è«‹è¼¸å…¥ä»£ç¢¼");

            try {
                const quote = await fetchQuoteSafe(stockId);
                if (!quote || quote.price === 0) throw new Error("ç„¡æ³•å–å¾—å ±åƒ¹");

                let history = [];
                try { history = await fetchFinMindHistory(stockId); } catch(e) {}

                const kdj = calculateKDJ(history);
                let buyPoint = history.length >= 5 ? Math.min(...history.slice(-5).map(d => d.min)) : quote.price * 0.95;

                currentStock = { id: stockId, name: quote.name, price: quote.price, buyPoint, kdj, change: quote.change };
                
                document.getElementById('analysisResult').classList.remove('hidden');
                document.getElementById('stockNameDisplay').innerText = `${quote.name} (${stockId})`;
                const color = quote.change >= 0 ? 'text-profit' : 'text-loss';
                document.getElementById('currentPrice').innerText = quote.price.toFixed(2);
                document.getElementById('currentPrice').className = `text-2xl font-bold ${color}`;
                document.getElementById('priceChange').innerText = quote.change.toFixed(2);
                document.getElementById('priceChange').className = `font-bold ${color}`;
                document.getElementById('recommendBuy').innerText = buyPoint.toFixed(1);
                
                if (kdj) {
                    document.getElementById('kVal').innerText = kdj.k.toFixed(1);
                    document.getElementById('dVal').innerText = kdj.d.toFixed(1);
                    document.getElementById('jVal').innerText = kdj.j.toFixed(1);
                } else {
                    document.getElementById('kVal').innerText = '50.0';
                    document.getElementById('dVal').innerText = '50.0';
                    document.getElementById('jVal').innerText = '50.0';
                }
            } catch (e) { alert("åˆ†æå¤±æ•—: " + e.message); }
        }

        async function fetchQuoteSafe(id) {
            try {
                const res = await fetch(`https://api.fugle.tw/marketdata/v1.0/stock/intraday/quote/${id}`, { headers: { "X-API-KEY": FUGLE_KEY } });
                const json = await res.json();
                if (json.lastTrade) return { price: json.lastTrade.price, change: json.lastTrade.price - json.openPrice, name: json.name };
            } catch(e) {
                try {
                    const res = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=${new Date().toISOString().split('T')[0]}&token=${FINMIND_TOKEN}`);
                    const json = await res.json();
                    if (json.data && json.data.length > 0) {
                        const last = json.data[json.data.length - 1];
                        return { price: last.close, change: last.spread, name: id };
                    }
                } catch(e2) {}
            }
            return null;
        }

        async function fetchFinMindHistory(id) {
            const start = new Date(Date.now() - 60 * 86400000).toISOString().split('T')[0];
            const res = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=${start}&token=${FINMIND_TOKEN}`);
            const json = await res.json();
            return json.msg === 'success' ? json.data : [];
        }

        function calculateKDJ(h) {
            if (!h || h.length < 9) return null;
            let k = 50, d = 50;
            for (let i = Math.max(0, h.length - 20); i < h.length; i++) {
                const slice = h.slice(Math.max(0, i - 8), i + 1);
                const c = h[i].close, mx = Math.max(...slice.map(x => x.max)), mn = Math.min(...slice.map(x => x.min));
                let rsv = mx === mn ? 50 : ((c - mn) / (mx - mn)) * 100;
                k = (2/3) * k + (1/3) * rsv;
                d = (2/3) * d + (1/3) * k;
            }
            return { k, d, j: 3 * k - 2 * d };
        }

        function openAddModal() { if (!currentStock) return alert("è«‹å…ˆåˆ†æä¸€æª”è‚¡ç¥¨"); document.getElementById('modalStockName').value = `${currentStock.name}`; document.getElementById('modalCost').value = currentStock.price; document.getElementById('addPortfolioModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('addPortfolioModal').classList.add('hidden'); }
        function confirmAddPortfolio() { const qty = +document.getElementById('modalQty').value; const cost = +document.getElementById('modalCost').value; if (!qty || !cost) return; portfolio.push({ id: currentStock.id, name: currentStock.name, cost, qty, curr: currentStock.price }); saveAndRender(); closeModal(); }
        function renderPortfolio() { const tbody = document.getElementById('portfolioBody'); let total = 0; tbody.innerHTML = ''; portfolio.forEach((p, i) => { const pnl = (p.curr - p.cost) * p.qty * 1000; total += pnl; const color = pnl >= 0 ? 'text-profit' : 'text-loss'; tbody.innerHTML += `<tr><td class="px-4 py-3">${p.name}</td><td class="px-4 py-3 text-right">${p.cost.toFixed(2)}</td><td class="px-4 py-3 text-right">${p.curr.toFixed(2)}</td><td class="px-4 py-3 text-right">${p.qty}</td><td class="px-4 py-3 text-right font-bold ${color}">${Math.round(pnl)}</td><td class="px-4 py-3 text-center"><button onclick="removeP(${i})" class="text-red-400">âœ•</button></td></tr>`; }); document.getElementById('totalProfit').innerText = Math.round(total).toLocaleString(); document.getElementById('totalProfit').className = `text-2xl font-bold ${total >= 0 ? 'text-profit' : 'text-loss'}`; }
        function removeP(i) { portfolio.splice(i, 1); saveAndRender(); }
        function saveAndRender() { localStorage.setItem('pro_portfolio_v3', JSON.stringify(portfolio)); renderPortfolio(); }
        function exportData() { if (!portfolio.length) return; navigator.clipboard.writeText(JSON.stringify(portfolio)); alert("âœ… è¤‡è£½æˆåŠŸ"); }
        function importData() { const code = prompt("è²¼ä¸Šä»£ç¢¼ï¼š"); if (code) { try { portfolio = JSON.parse(code); saveAndRender(); alert("âœ… é‚„åŸæˆåŠŸ"); } catch (e) { alert("âŒ éŒ¯èª¤"); } } }
        async function updatePortfolioPrices() { for (let p of portfolio) { try { const q = await fetchQuoteSafe(p.id); if (q) p.curr = q.price; } catch(e){} } saveAndRender(); }
    </script>
</body>
</html>
