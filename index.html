<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡é›™å¼•æ“å„€è¡¨æ¿ v5.5 (å¤–è³‡çµæ‰‹ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Microsoft JhengHei', sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; }
        .input-field { background-color: #0f172a; border: 1px solid #475569; color: white; }
        .btn-primary { background-color: #06b6d4; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #0891b2; }
        .text-profit { color: #ef4444; } 
        .text-loss { color: #22c55e; }
        .buy-point { color: #facc15; font-weight: bold; }
        
        .kdj-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; width: 60px; text-align: center; }
        .kdj-overbought { background-color: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid #ef4444; }
        .kdj-oversold { background-color: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid #22c55e; }
        .kdj-neutral { background-color: rgba(148, 163, 184, 0.2); color: #cbd5e1; border: 1px solid #64748b; }
        
        .status-tag { font-size: 0.65rem; padding: 1px 4px; border-radius: 2px; font-weight: bold; }
        .status-hot { background: linear-gradient(90deg, #be185d, #db2777); color: white; }
        
        .foreign-hunter-tag { 
            background: linear-gradient(90deg, #7c3aed, #db2777); 
            color: white; 
            font-size: 0.7rem; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-weight: bold; 
            animation: pulse 1.5s infinite; 
            display: inline-block;
        }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }

        .buy-icon { font-size: 1rem; animation: bounce 1s infinite; display: inline-block; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        
        .bid-bar { background-color: rgba(239, 68, 68, 0.2); height: 100%; border-radius: 2px; transition: width 0.3s; }
        .ask-bar { background-color: rgba(34, 197, 94, 0.2); height: 100%; border-radius: 2px; transition: width 0.3s; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(2px); }
        #alertModal { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="p-4 md:p-8 relative">

    <!-- Modal & Alert -->
    <div id="addPortfolioModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay">
        <div class="bg-slate-800 rounded-lg border border-slate-600 p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4">ğŸ“¥ åŠ å…¥æŒå€‰</h3>
            <div class="mb-4"><label class="block text-slate-400 text-sm mb-1">è‚¡ç¥¨åç¨±</label><input type="text" id="modalStockName" class="w-full bg-slate-700 text-white px-3 py-2 rounded border border-slate-600" disabled></div>
            <div class="mb-4"><label class="block text-slate-400 text-sm mb-1">æŒæœ‰å¼µæ•¸</label><input type="number" id="modalQty" class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-cyan-500 focus:outline-none" value="1"></div>
            <div class="mb-6"><label class="block text-slate-400 text-sm mb-1">è²·å…¥æˆæœ¬åƒ¹</label><input type="number" id="modalCost" class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-cyan-500 focus:outline-none"></div>
            <div class="flex justify-end gap-3"><button onclick="closeModal()" class="px-4 py-2 text-slate-300 hover:text-white">å–æ¶ˆ</button><button onclick="confirmAddPortfolio()" class="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold">ç¢ºèªåŠ å…¥</button></div>
        </div>
    </div>

    <div id="bigOrderAlert" class="fixed inset-0 z-[60] hidden flex items-center justify-center pointer-events-none">
        <div id="alertModal" class="bg-gradient-to-b from-slate-700 to-slate-900 rounded-xl border-2 border-pink-500 p-0 w-80 shadow-2xl pointer-events-auto overflow-hidden">
            <div class="bg-gradient-to-r from-slate-800 to-slate-700 p-3 border-b border-slate-600 flex justify-between items-center"><h3 class="text-lg font-bold text-white flex items-center"><span class="mr-2 text-pink-400">ğŸš€</span> å¤–è³‡çµæ‰‹è­¦ç¤º</h3><button onclick="closeAlert()" class="text-slate-400 hover:text-white text-xl">Ã—</button></div>
            <div class="p-6 text-center">
                <p id="alertTime" class="text-sm text-slate-400 mb-2">--:--</p>
                <h4 id="alertStock" class="text-2xl font-bold text-white mb-1">--</h4>
                <p class="text-lg text-slate-300">ç¾åƒ¹ <span id="alertPrice" class="text-profit font-bold">--</span></p>
                <div class="mt-4 bg-slate-800/50 rounded p-2 border border-slate-700">
                    <p class="text-yellow-400 font-bold text-xl">âš¡ é€£çºŒè²·ç›¤</p>
                    <p id="alertDesc" class="text-xs text-slate-500 mt-1">å¤–è³‡ç©æ¥µæ•²é€²ä¸­</p>
                </div>
            </div>
            <div class="flex border-t border-slate-600"><button onclick="closeAlert()" class="flex-1 py-3 text-slate-300 hover:bg-slate-700 transition">å¿½ç•¥</button><button onclick="closeAlert()" class="flex-1 py-3 text-cyan-400 font-bold hover:bg-slate-700 transition border-l border-slate-600">ç¢ºèª</button></div>
        </div>
    </div>

    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-cyan-400">ğŸš€ å°è‚¡é›™å¼•æ“å„€è¡¨æ¿</h1>
            <p class="text-slate-400 text-sm mt-1">v5.5 å¤–è³‡çµæ‰‹ç‰ˆ | åµæ¸¬é€£çºŒå¤–ç›¤è²·å–®</p>
        </div>
        <div class="text-right"><div id="updateTime" class="text-xs text-slate-500">æ›´æ–°ä¸­...</div></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- å·¦å´ -->
        <div class="lg:col-span-1 space-y-6">
            <div class="card p-5">
                <h2 class="text-xl font-bold mb-4 border-l-4 border-cyan-400 pl-3">ğŸ” å€‹è‚¡è¨ºæ–·</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="stockInput" placeholder="ä»£ç¢¼ (ä¾‹: 2330)" class="input-field flex-1 px-4 py-2 rounded-lg focus:outline-none focus:border-cyan-400">
                    <button onclick="analyzeStock()" class="btn-primary px-6 py-2 rounded-lg font-bold">åˆ†æ</button>
                </div>
                <div id="analysisResult" class="hidden space-y-4">
                    <div class="flex justify-between items-end border-b border-slate-700 pb-3">
                        <div><h3 id="stockNameDisplay" class="text-2xl font-bold text-white">--</h3><span id="kdjStatusBadge" class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">--</span></div>
                        <div class="text-right"><div id="currentPrice" class="text-4xl font-bold text-white">--</div><div id="priceChange" class="text-base font-bold text-slate-400">--</div></div>
                    </div>
                    <div class="bg-slate-900/50 p-2 rounded border border-slate-700 text-xs">
                        <div class="grid grid-cols-2 gap-4">
                            <div><div class="text-center text-slate-500 mb-1">å§”è²·</div><div id="bidTable" class="space-y-1"></div></div>
                            <div><div class="text-center text-slate-500 mb-1">å§”è³£</div><div id="askTable" class="space-y-1"></div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center bg-slate-800 p-2 rounded border border-slate-700">
                        <div><div class="text-xs text-slate-500">Kå€¼</div><div id="kVal" class="font-mono font-bold text-white">--</div></div>
                        <div><div class="text-xs text-slate-500">Då€¼</div><div id="dVal" class="font-mono font-bold text-white">--</div></div>
                        <div><div class="text-xs text-slate-500">Jå€¼</div><div id="jVal" class="font-mono font-bold text-white">--</div></div>
                    </div>
                    <div class="bg-slate-800/80 p-3 rounded-lg border border-yellow-600/30 mt-2 flex justify-between items-center">
                        <div><div class="text-sm text-slate-400">ğŸ¯ å»ºè­°è²·é»</div><div id="recommendBuy" class="text-2xl font-mono text-yellow-400 font-bold">--</div></div>
                        <div class="text-right"><div id="diffText" class="text-xs text-slate-400">è·ç¾åƒ¹ --%</div><div id="buySignalIcon" class="hidden text-2xl">ğŸ¯</div></div>
                    </div>
                    <button onclick="openAddModal()" class="w-full bg-cyan-700 hover:bg-cyan-600 text-white py-3 rounded-lg mt-4 transition shadow-lg">+ åŠ å…¥æŒå€‰</button>
                </div>
            </div>

            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <div><h2 class="text-xl font-bold border-l-4 border-pink-500 pl-3">ğŸ”¥ AI ç†±é–€æ¦œ</h2></div>
                    <button onclick="scanTrendingStocks()" class="text-xs bg-pink-900 hover:bg-pink-800 text-pink-100 px-3 py-1 rounded border border-pink-700"><span class="animate-spin mr-1 hidden" id="scanSpinner">âŸ³</span> åˆ·æ–°</button>
                </div>
                <div class="overflow-x-auto h-[500px] pr-1">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800 sticky top-0 z-10">
                            <tr>
                                <th class="px-2 py-2">è‚¡å</th>
                                <th class="px-2 py-2 text-right">ç¾åƒ¹</th>
                                <th class="px-2 py-2 text-center">ç‹€æ…‹</th>
                                <th class="px-2 py-2 text-right">KDJ</th>
                                <th class="px-2 py-2 text-center">è¨Šè™Ÿ</th>
                            </tr>
                        </thead>
                        <tbody id="watchlistBody" class="divide-y divide-slate-700">
                            <tr><td colspan="5" class="text-center py-8 text-slate-500">æ­£åœ¨è¼‰å…¥ç†±é–€è‚¡æ•¸æ“š...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- å³å´ -->
        <div class="lg:col-span-2 space-y-6">
            <!-- å¤§æˆ¶é›·é” (å¤–è³‡çµæ‰‹) -->
            <div class="card p-5 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-purple-500/10 rounded-full blur-xl -mr-10 -mt-10 pointer-events-none"></div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-purple-500 pl-3 flex items-center">
                        ğŸ“¡ å¤–è³‡çµæ‰‹ 
                        <span class="ml-2 text-xs bg-purple-900 text-purple-300 px-2 py-0.5 rounded animate-pulse">LIVE</span>
                    </h2>
                    <div class="text-xs text-slate-400">åµæ¸¬æ¨¡å¼ï¼š<span class="text-purple-400 font-bold">é€£çºŒå¤–ç›¤å¤§å–®</span></div>
                </div>
                <div class="overflow-x-auto max-h-64 bg-black/20 rounded-lg border border-slate-700/50">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800 sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3">æ™‚é–“</th>
                                <th class="px-4 py-3">è‚¡ç¥¨</th>
                                <th class="px-4 py-3 text-right">é€£çºŒå–®(å¼µ)</th>
                                <th class="px-4 py-3 text-right">æˆäº¤åƒ¹</th>
                                <th class="px-4 py-3">ä¸»åŠ›å‹•æ…‹</th>
                                <th class="px-4 py-3 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="bigOrderBody" class="divide-y divide-slate-700">
                            <tr><td colspan="6" class="text-center py-12 text-slate-500">æ­£åœ¨æƒæå¤–è³‡è¹¤è·¡ (é–€æª» > 50 å¼µ)...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æŒå€‰ç®¡ç† -->
            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-purple-400 pl-3">ğŸ’¼ æŒå€‰æç›Š</h2>
                    <div class="flex gap-2">
                        <button onclick="exportData()" class="text-xs bg-blue-900 text-blue-300 px-3 py-1 rounded border border-blue-700">å‚™ä»½</button>
                        <button onclick="importData()" class="text-xs bg-green-900 text-green-300 px-3 py-1 rounded border border-green-700">é‚„åŸ</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800/80">
                            <tr><th class="px-4 py-3">è‚¡ç¥¨</th><th class="px-4 py-3 text-right">æˆæœ¬</th><th class="px-4 py-3 text-right">ç¾åƒ¹</th><th class="px-4 py-3 text-right">åº«å­˜</th><th class="px-4 py-3 text-right">æç›Š</th><th class="px-4 py-3 text-center">KDJ</th><th class="px-4 py-3 text-center">åˆªé™¤</th></tr>
                        </thead>
                        <tbody id="portfolioBody" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
                <div class="text-right mt-4"><span class="text-sm text-slate-400 mr-2">ç¸½æç›Š:</span><span id="totalProfit" class="text-2xl font-bold text-white">0</span></div>
            </div>
        </div>
    </div>

    <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

    <script>
        const FUGLE_KEY = "OGNiYzc2YmQtMzdjYS00NTJkLWI1ZGUtNjY1ODRhNTMwNTAxIDhlMTRiMDVkLTk0NzItNDUzMi05NjY2LTkzYjlhMTQ5NzBjMw==";
        const FINMIND_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNS0xMS0yNyAxMjoyOToyOSIsInVzZXJfaWQiOiJMSU5QRyIsImlwIjoiMS4xNzAuMTE0LjIwIn0.SyyVMOX2eF6uNVO3EZpkRylFrQqFFXjH1PJcM5oFQt0";

        const HOT_STOCKS_POOL = [
            '2330', '2317', '2454', '2382', '3231', '6669', '2356', '3035', '3443', '3661', 
            '3037', '2376', '2368', '3017', '3583', '3131', '6187', '1513', '1519', '1514', 
            '2603', '2609', '2615', '2881', '2882', '2891', '3034', '3711', '4961', '2408'
        ];
        
        let currentStock = null;
        let portfolio = JSON.parse(localStorage.getItem('pro_portfolio_v3')) || [];
        let lastAlertTime = 0;
        // ç´€éŒ„æ¯æª”è‚¡ç¥¨æœ€è¿‘ä¸€æ¬¡å¤§å–®æ™‚é–“ï¼Œç”¨ä¾†åˆ¤æ–·ã€Œé€£çºŒæ€§ã€
        let lastBigOrderMap = {}; 

        window.onload = () => {
            renderPortfolio();
            scanTrendingStocks(); 
            setInterval(updatePortfolioPrices, 30000);
            setInterval(scanBigOrders, 5000); 
        };

        // ğŸ”¥ å¤–è³‡çµæ‰‹æ ¸å¿ƒé‚è¼¯
        async function scanBigOrders() {
            const tbody = document.getElementById('bigOrderBody');
            if(tbody.innerHTML.includes('æƒæ')) tbody.innerHTML = '';
            
            const randomTargets = HOT_STOCKS_POOL.sort(() => 0.5 - Math.random()).slice(0, 5); // æ¯æ¬¡æƒ 5 æª”
            for (const id of randomTargets) {
                try {
                    const res = await fetch(`https://api.fugle.tw/marketdata/v1.0/stock/intraday/quote/${id}`, { headers: { "X-API-KEY": FUGLE_KEY } });
                    const json = await res.json();
                    const trade = json.lastTrade;
                    
                    if (trade && trade.unit >= 50) { // é–€æª» 50 å¼µ
                        const now = Date.now();
                        const lastTime = lastBigOrderMap[id] || 0;
                        const isConsecutive = (now - lastTime) < 60000; // 60ç§’å…§é€£çºŒå‡ºç¾
                        lastBigOrderMap[id] = now;

                        // å¤–ç›¤æˆäº¤ä½”æ¯” > 55% (è²·æ°£å¼·)
                        const buyPower = (json.total.tradeVolumeAtAsk / json.total.tradeVolume) * 100;
                        
                        let hunterTag = '';
                        // å¦‚æœæ˜¯ é€£çºŒå¤§å–® + å¤–ç›¤æˆäº¤ï¼Œè¦–ç‚ºå¤–è³‡è²·ç›¤
                        if (isConsecutive && buyPower > 55) {
                            hunterTag = `<span class="foreign-hunter-tag">ğŸ”¥ å¤–è³‡é€£è²·</span>`;
                            const time = new Date(json.lastUpdated / 1000).toLocaleTimeString();
                            showAlert(`${json.name} (${id})`, trade.price, trade.unit, time, "é€£çºŒè²·ç›¤åµæ¸¬");
                            
                            const rowHTML = `
                                <tr class="big-order-row border-b border-slate-700 cursor-pointer hover:bg-slate-700" onclick="analyzeStock('${id}')">
                                    <td class="px-4 py-3 text-slate-400 font-mono text-xs">${time}</td>
                                    <td class="px-4 py-3 font-bold text-white">${json.name}</td>
                                    <td class="px-4 py-3 text-right text-yellow-400 font-bold text-lg">âš¡ ${trade.unit}</td>
                                    <td class="px-4 py-3 text-right text-white">${trade.price}</td>
                                    <td class="px-4 py-3">${hunterTag}</td>
                                    <td class="px-4 py-3 text-center"><button class="text-xs bg-cyan-900 text-cyan-300 px-2 py-1 rounded">åˆ†æ</button></td>
                                </tr>`;
                            tbody.insertAdjacentHTML('afterbegin', rowHTML);
                            if(tbody.rows.length > 50) tbody.deleteRow(-1);
                        }
                    }
                } catch(e) {}
            }
        }

        // ğŸ”” å½ˆçª—å„ªåŒ–
        function showAlert(stockName, price, vol, time, desc) {
            if (Date.now() - lastAlertTime < 5000) return;
            lastAlertTime = Date.now();
            const modal = document.getElementById('bigOrderAlert');
            document.getElementById('alertTime').innerText = time;
            document.getElementById('alertStock').innerText = stockName;
            document.getElementById('alertPrice').innerText = price;
            document.getElementById('alertVol').innerText = vol;
            document.getElementById('alertDesc').innerText = desc || "å¤–è³‡ç©æ¥µæ•²é€²ä¸­";
            modal.classList.remove('hidden');
            try { document.getElementById('alertSound').play(); } catch(e){}
            setTimeout(() => { modal.classList.add('hidden'); }, 5000);
        }
        function closeAlert() { document.getElementById('bigOrderAlert').classList.add('hidden'); }

        // å…¶ä»–åŠŸèƒ½ä¿æŒ v5.4 ç‰ˆæœ¬...
        async function scanTrendingStocks() {
            const tbody = document.getElementById('watchlistBody');
            const spinner = document.getElementById('scanSpinner');
            spinner.classList.remove('hidden');
            const trendingList = [];
            const batch = HOT_STOCKS_POOL.sort(() => 0.5 - Math.random()).slice(0, 15);
            await Promise.all(batch.map(async (id) => {
                try {
                    const quote = await fetchFugleQuote(id);
                    if (!quote.lastPrice) return;
                    let kdjText = '-';
                    let buyPoint = quote.lastPrice * 0.9;
                    try {
                        const history = await fetchFinMindHistory(id);
                        const kdj = calculateKDJ(history);
                        if (kdj) kdjText = `${kdj.k.toFixed(0)}`;
                        if (history.length >= 5) buyPoint = Math.min(...history.slice(-5).map(d => d.min));
                    } catch(e) {}
                    const score = quote.changePercent || 0;
                    trendingList.push({ id: id, name: quote.name, price: quote.lastPrice, change: quote.changePercent, kdjText: kdjText, buyPoint: buyPoint, score: score });
                } catch (e) {}
            }));
            trendingList.sort((a, b) => b.score - a.score);
            tbody.innerHTML = '';
            if (trendingList.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-slate-500">ç„¡è³‡æ–™</td></tr>'; } 
            else {
                trendingList.forEach(stock => {
                    let statusTag = '<span class="text-xs text-slate-500">ç›¤æ•´</span>';
                    if (stock.score > 0.01) statusTag = '<span class="status-tag status-hot">ğŸ”¥ å¼·å‹¢</span>';
                    let signalIcon = '';
                    const diff = ((stock.price - stock.buyPoint) / stock.buyPoint * 100);
                    if (diff < 2 && diff > -2) signalIcon = '<span class="buy-icon text-yellow-400">ğŸ¯</span>';
                    const color = stock.change >= 0 ? 'text-profit' : 'text-loss';
                    tbody.innerHTML += `<tr class="hover:bg-slate-700 cursor-pointer border-b border-slate-700/50" onclick="analyzeStock('${stock.id}')"><td class="px-2 py-3 font-bold text-white">${stock.name} <span class="text-[10px] text-slate-400 block">${stock.id}</span></td><td class="px-2 py-3 text-right ${color}">${stock.price}</td><td class="px-2 py-3 text-center">${statusTag}</td><td class="px-2 py-3 text-right font-mono text-xs text-slate-400">${stock.kdjText}</td><td class="px-2 py-3 text-center">${signalIcon}</td></tr>`;
                });
            }
            spinner.classList.add('hidden');
        }
        async function analyzeStock(inputId = null) {
            const stockId = inputId || document.getElementById('stockInput').value.trim();
            if (!stockId) return alert("è«‹è¼¸å…¥ä»£ç¢¼");
            const btn = document.querySelector('button[onclick="analyzeStock()"]');
            if(btn) btn.innerText = "...";
            try {
                const fugleData = await fetchFugleQuote(stockId);
                if (!fugleData || !fugleData.lastPrice) throw new Error("Fugle å ±åƒ¹å¤±æ•—");
                let historyData = [];
                try { historyData = await fetchFinMindHistory(stockId); } catch (err) {}
                const kdj = calculateKDJ(historyData);
                let buyPoint = historyData.length >= 5 ? Math.min(...historyData.slice(-5).map(d => d.min)) : fugleData.lastPrice * 0.95;
                currentStock = { id: stockId, name: fugleData.name, price: fugleData.lastPrice, buyPoint: buyPoint, kdj: kdj };
                updateAnalysisUI(currentStock, fugleData);
                renderOrderBook(fugleData.bids, fugleData.asks);
            } catch (e) { console.error(e); alert("åˆ†æå¤±æ•—: " + e.message); } 
            finally { if(btn) btn.innerText = "åˆ†æ"; }
        }
        function renderOrderBook(bids, asks) {
            const bidEl = document.getElementById('bidTable'); const askEl = document.getElementById('askTable');
            bidEl.innerHTML = ''; askEl.innerHTML = '';
            if (!bids || !asks) { bidEl.innerHTML = '<div class="text-center text-xs text-slate-600">ç„¡æ•¸æ“š</div>'; return; }
            bids.slice(0, 5).forEach(b => bidEl.innerHTML += `<div class="flex justify-between items-center order-book-row relative"><div class="absolute right-0 top-0 bottom-0 bid-bar" style="width: ${Math.min(100, (b.volume/50)*100)}%"></div><span class="text-white z-10">${b.volume}</span><span class="text-profit font-bold z-10">${b.price}</span></div>`);
            asks.slice(0, 5).reverse().forEach(a => askEl.innerHTML += `<div class="flex justify-between items-center order-book-row relative"><div class="absolute left-0 top-0 bottom-0 ask-bar" style="width: ${Math.min(100, (a.volume/50)*100)}%"></div><span class="text-loss font-bold z-10">${a.price}</span><span class="text-white z-10">${a.volume}</span></div>`);
        }
        function updateAnalysisUI(stock, fugle) {
            document.getElementById('analysisResult').classList.remove('hidden');
            document.getElementById('stockNameDisplay').innerText = `${stock.name} (${stock.id})`;
            const color = fugle.change >= 0 ? 'text-profit' : 'text-loss';
            document.getElementById('currentPrice').innerText = stock.price; document.getElementById('currentPrice').className = `text-4xl font-bold ${color}`;
            document.getElementById('priceChange').innerText = `${fugle.change} (${(fugle.changePercent*100).toFixed(2)}%)`; document.getElementById('priceChange').className = `text-base font-bold ${color}`;
            document.getElementById('recommendBuy').innerText = stock.buyPoint.toFixed(1);
            document.getElementById('diffText').innerText = `è·ç¾åƒ¹ ${((stock.price - stock.buyPoint) / stock.buyPoint * 100).toFixed(1)}%`;
            const badge = document.getElementById('kdjStatusBadge'); const icon = document.getElementById('buySignalIcon');
            if (stock.kdj) {
                const { k, d, j } = stock.kdj;
                document.getElementById('kVal').innerText = k.toFixed(1); document.getElementById('dVal').innerText = d.toFixed(1); document.getElementById('jVal').innerText = j.toFixed(1);
                if (k > 80) { badge.innerText = "âš ï¸ è¶…è²·"; badge.className="text-xs bg-red-900 text-red-300 px-2 py-1 rounded"; }
                else if (k < 20) { badge.innerText = "ğŸ’ è¶…è³£"; badge.className="text-xs bg-green-900 text-green-300 px-2 py-1 rounded"; }
                else { badge.innerText = "å¾˜å¾Šå€"; badge.className="text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded"; }
            } else { document.getElementById('kVal').innerText = "--"; badge.innerText = "è³‡æ–™ä¸è¶³"; }
            if (((stock.price - stock.buyPoint) / stock.buyPoint * 100) < 2) { icon.classList.remove('hidden'); } else { icon.classList.add('hidden'); }
        }
        async function fetchFugleQuote(id) {
            const res = await fetch(`https://api.fugle.tw/marketdata/v1.0/stock/intraday/quote/${id}`, { headers: { "X-API-KEY": FUGLE_KEY } });
            const json = await res.json(); return { ...json, bids: json.order?.bids || [], asks: json.order?.asks || [] };
        }
        async function fetchFinMindHistory(id) {
            const startDate = new Date(Date.now() - 60 * 86400000).toISOString().split('T')[0];
            const res = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=${startDate}&token=${FINMIND_TOKEN}`);
            const json = await res.json(); if (json.msg === 'success' && json.data) return json.data; throw new Error("FinMind error");
        }
        function calculateKDJ(h) {
            if (!h || h.length < 9) return null; let k = 50, d = 50;
            for (let i = Math.max(0, h.length - 20); i < h.length; i++) {
                const slice = h.slice(Math.max(0, i - 8), i + 1); const c = h[i].close, mx = Math.max(...slice.map(x => x.max)), mn = Math.min(...slice.map(x => x.min));
                let rsv = mx === mn ? 50 : ((c - mn) / (mx - mn)) * 100; k = (2/3) * k + (1/3) * rsv; d = (2/3) * d + (1/3) * k;
            } return { k, d, j: 3 * k - 2 * d };
        }
        function openAddModal() { if (!currentStock) return alert("è«‹å…ˆåˆ†æä¸€æª”è‚¡ç¥¨"); document.getElementById('modalStockName').value = `${currentStock.name} (${currentStock.id})`; document.getElementById('modalCost').value = currentStock.price; document.getElementById('addPortfolioModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('addPortfolioModal').classList.add('hidden'); }
        function confirmAddPortfolio() { const qty = parseFloat(document.getElementById('modalQty').value); const cost = parseFloat(document.getElementById('modalCost').value); if (!qty || !cost) return alert("è¼¸å…¥éŒ¯èª¤"); portfolio.push({ id: currentStock.id, name: currentStock.name, cost: cost, qty: qty, curr: currentStock.price, kdjState: currentStock.kdj ? (currentStock.kdj.k > 80 ? 'high' : (currentStock.kdj.k < 20 ? 'low' : 'mid')) : 'mid' }); saveAndRender(); closeModal(); }
        function renderPortfolio() {
            const tbody = document.getElementById('portfolioBody'); let totalPnL = 0; tbody.innerHTML = '';
            portfolio.forEach((p, i) => {
                const profit = (p.curr - p.cost) * p.qty * 1000; totalPnL += profit; const color = profit >= 0 ? 'text-profit' : 'text-loss';
                let kdjSignal = '<span class="kdj-tag kdj-neutral">âšª å¾˜å¾Šå€</span>';
                if (p.kdjState === 'high') kdjSignal = '<span class="kdj-tag kdj-overbought">ğŸ”´ è³£å‡ºè¨Šè™Ÿ</span>'; else if (p.kdjState === 'low') kdjSignal = '<span class="kdj-tag kdj-oversold">ğŸŸ¢ åŠ ç¢¼è¨Šè™Ÿ</span>';
                tbody.innerHTML += `<tr class="hover:bg-slate-800/50 border-b border-slate-700/50"><td class="px-4 py-3 font-bold text-white">${p.name}</td><td class="px-4 py-3 text-right">${p.cost}</td><td class="px-4 py-3 text-right text-white">${p.curr}</td><td class="px-4 py-3 text-right">${p.qty}</td><td class="px-4 py-3 text-right font-bold ${color}">${Math.round(profit)}</td><td class="px-4 py-3 text-center">${kdjSignal}</td><td class="px-4 py-3 text-center"><button onclick="removeP(${i})" class="text-red-400">âœ•</button></td></tr>`;
            });
            document.getElementById('totalProfit').innerText = Math.round(totalPnL).toLocaleString(); document.getElementById('totalProfit').className = `text-2xl font-bold ${totalPnL >= 0 ? 'text-profit' : 'text-loss'}`;
        }
        function removeP(i) { portfolio.splice(i, 1); saveAndRender(); }
        function saveAndRender() { localStorage.setItem('pro_portfolio_v3', JSON.stringify(portfolio)); renderPortfolio(); }
        function exportData() { if (portfolio.length === 0) return alert("ç„¡è³‡æ–™å¯å‚™ä»½"); const code = JSON.stringify(portfolio); navigator.clipboard.writeText(code).then(() => alert("âœ… ä»£ç¢¼å·²è¤‡è£½")).catch(() => { console.log(code); alert("è¤‡è£½å¤±æ•—ï¼Œè«‹çœ‹ Console"); }); }
        function importData() { const code = prompt("è«‹è²¼ä¸Šå‚™ä»½ä»£ç¢¼ï¼š"); if (!code) return; try { portfolio = JSON.parse(code); saveAndRender(); alert("âœ… é‚„åŸæˆåŠŸ"); } catch (e) { alert("âŒ ä»£ç¢¼éŒ¯èª¤"); } }
        async function updatePortfolioPrices() { for(let p of portfolio) { try { const q = await fetchFugleQuote(p.id); if(q.lastPrice) p.curr = q.lastPrice; const h = await fetchFinMindHistory(p.id); const k = calculateKDJ(h); if(k) p.kdjState = k.k > 80 ? 'high' : k.k < 20 ? 'low' : 'mid'; } catch(e){} } saveAndRender(); }
    </script>
</body>
</html>
