<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡é›™å¼•æ“å„€è¡¨æ¿ v3.2 (å«å¤–è³‡ç‹™æ“Š)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Microsoft JhengHei', sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; }
        .input-field { background-color: #0f172a; border: 1px solid #475569; color: white; }
        .btn-primary { background-color: #06b6d4; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #0891b2; }
        .text-profit { color: #ef4444; } 
        .text-loss { color: #22c55e; }
        .buy-point { color: #facc15; font-weight: bold; }
        /* è‡ªè¨‚æ²è»¸ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- é ‚éƒ¨å°èˆª -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-cyan-400">ğŸš€ å°è‚¡é›™å¼•æ“å„€è¡¨æ¿</h1>
            <p class="text-slate-400 text-sm mt-1">Fugle (å³æ™‚) + FinMind (æ­·å²) | å¤–è³‡ç‹™æ“Šç‰ˆ</p>
        </div>
        <div class="text-right">
            <div id="updateTime" class="text-xs text-slate-500">æ›´æ–°ä¸­...</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- å·¦å´ï¼šå€‹è‚¡è¨ºæ–· -->
        <div class="lg:col-span-1 space-y-6">
            <div class="card p-5">
                <h2 class="text-xl font-bold mb-4 border-l-4 border-cyan-400 pl-3">ğŸ” å€‹è‚¡è¨ºæ–·</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="stockInput" placeholder="è¼¸å…¥ä»£ç¢¼ (å¦‚ 2330)" class="input-field flex-1 px-4 py-2 rounded-lg focus:outline-none focus:border-cyan-400">
                    <button onclick="analyzeStock()" class="btn-primary px-6 py-2 rounded-lg font-bold">åˆ†æ</button>
                </div>
                
                <div id="analysisResult" class="hidden space-y-4">
                    <div class="flex justify-between items-end border-b border-slate-700 pb-3">
                        <div>
                            <h3 id="stockNameDisplay" class="text-2xl font-bold text-white">--</h3>
                            <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">äº¤æ˜“ä¸­</span>
                        </div>
                        <div class="text-right">
                            <div id="currentPrice" class="text-4xl font-bold text-white">--</div>
                            <div id="priceChange" class="text-base font-bold text-slate-400">--</div>
                        </div>
                    </div>

                    <div class="bg-slate-800/80 p-3 rounded-lg border border-yellow-600/30">
                        <div class="flex justify-between items-center text-sm mb-1">
                            <span class="text-slate-400">ğŸ¯ ç³»çµ±å»ºè­°è²·é»</span>
                            <span class="text-xs text-yellow-500 bg-yellow-900/20 px-2 rounded">æ”¯æ’ç®—æ³•</span>
                        </div>
                        <div class="flex justify-between items-end">
                            <span id="recommendBuy" class="text-2xl font-mono text-yellow-400 font-bold">--</span>
                            <span id="diffText" class="text-xs text-slate-400">è·ç¾åƒ¹ --%</span>
                        </div>
                    </div>

                    <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                        <div class="flex justify-between mb-2">
                            <span class="text-cyan-400 font-bold">AI ç¶œåˆè©•åˆ†</span>
                            <span id="aiScore" class="font-bold text-white text-xl">--</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2 mb-3">
                            <div id="scoreBar" class="bg-cyan-500 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <div class="space-y-1 text-xs text-slate-400">
                            <div class="flex justify-between"><span>å¤–è³‡å‹•å‘</span><span id="chipStatus">--</span></div>
                            <div class="flex justify-between"><span>æŠ€è¡“å‹æ…‹</span><span id="techStatus">--</span></div>
                        </div>
                    </div>

                    <button onclick="addToPortfolio()" class="w-full bg-cyan-700 hover:bg-cyan-600 text-white py-3 rounded-lg mt-2 transition shadow-lg">
                        + åŠ å…¥æŒå€‰
                    </button>
                </div>
            </div>

            <!-- è§€å¯Ÿæ¸…å–® -->
            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-yellow-400 pl-3">ğŸ“‹ è§€å¯Ÿåå–®</h2>
                    <button onclick="refreshWatchlist()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-slate-300">æ›´æ–°</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800">
                            <tr>
                                <th class="px-2 py-2">è‚¡å</th>
                                <th class="px-2 py-2 text-right">ç¾åƒ¹</th>
                                <th class="px-2 py-2 text-right text-yellow-400">è²·é»</th>
                                <th class="px-2 py-2 text-right">ç©ºé–“</th>
                            </tr>
                        </thead>
                        <tbody id="watchlistBody" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šå¤–è³‡ç‹™æ“Š & æŒå€‰ -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- ğŸ”¥ æ–°å¢ï¼šå¤–è³‡ç‹™æ“Šåå–® -->
            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-pink-500 pl-3">ğŸ’° å¤–è³‡å¤§æˆ¶ç‹™æ“Š (é€£è²·)</h2>
                    <button onclick="scanForeignBuy()" class="text-xs bg-pink-900/50 hover:bg-pink-900 text-pink-300 px-3 py-1 rounded border border-pink-700">ğŸš€ æƒæå¤§æˆ¶å‹•å‘</button>
                </div>
                <div class="overflow-x-auto max-h-60">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800 sticky top-0">
                            <tr>
                                <th class="px-4 py-3">è‚¡ç¥¨</th>
                                <th class="px-4 py-3 text-right">å¤–è³‡è²·è¶… (å¼µ)</th>
                                <th class="px-4 py-3 text-right">é€£è²·å¤©æ•¸</th>
                                <th class="px-4 py-3 text-right">ç¾åƒ¹</th>
                                <th class="px-4 py-3 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="foreignBuyBody" class="divide-y divide-slate-700">
                            <tr><td colspan="5" class="text-center py-8 text-slate-500">é»æ“Šã€Œæƒæã€æŸ¥çœ‹å¤–è³‡æ­£åœ¨å·å·è²·é€²çš„è‚¡ç¥¨...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æŒå€‰ç®¡ç† -->
            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-purple-400 pl-3">ğŸ’¼ æŒå€‰æç›Š</h2>
                    <span id="totalProfit" class="text-2xl font-bold text-white">0</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800/80">
                            <tr>
                                <th class="px-4 py-3">è‚¡ç¥¨</th>
                                <th class="px-4 py-3 text-right">æˆæœ¬</th>
                                <th class="px-4 py-3 text-right">ç¾åƒ¹</th>
                                <th class="px-4 py-3 text-right">åº«å­˜</th>
                                <th class="px-4 py-3 text-right">æç›Š</th>
                                <th class="px-4 py-3 text-center">åˆªé™¤</th>
                            </tr>
                        </thead>
                        <tbody id="portfolioBody" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”‘ API è¨­å®š
        const FUGLE_KEY = "OGNiYzc2YmQtMzdjYS00NTJkLWI1ZGUtNjY1ODRhNTMwNTAxIDhlMTRiMDVkLTk0NzItNDUzMi05NjY2LTkzYjlhMTQ5NzBjMw==";
        const FINMIND_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNS0xMS0yNyAxMjoyOToyOSIsInVzZXJfaWQiOiJMSU5QRyIsImlwIjoiMS4xNzAuMTE0LjIwIn0.SyyVMOX2eF6uNVO3EZpkRylFrQqFFXjH1PJcM5oFQt0";

        // é è¨­æƒæç›®æ¨™ (ç†±é–€æ¬Šå€¼è‚¡æ± ï¼Œé¿å…æƒæå…¨å¸‚å ´å¤ªæ…¢)
        const SCAN_POOL = ['2330','2317','2454','2603','2881','2308','3037','2382','3231','6669','2303','2882','2891','1101','1303','2002','2912'];
        const WATCH_LIST_IDS = ['2330', '2317', '2454', '2603', '2881'];
        
        let currentStock = null;
        let portfolio = JSON.parse(localStorage.getItem('pro_portfolio_v3')) || [];

        window.onload = () => {
            renderPortfolio();
            refreshWatchlist();
            setInterval(updatePortfolioPrices, 60000);
        };

        // ğŸ”¥ å¤–è³‡å¤§æˆ¶æƒæ
        async function scanForeignBuy() {
            const tbody = document.getElementById('foreignBuyBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-pink-400 animate-pulse">æ­£åœ¨æƒææ³•äººå¤§æ•¸æ“š...</td></tr>';
            
            let results = [];
            const startDate = new Date(Date.now() - 10 * 86400000).toISOString().split('T')[0]; // æŠ“è¿‘10å¤©

            // ä¸¦è¡Œè™•ç†åŠ é€Ÿæƒæ
            const promises = SCAN_POOL.map(async (id) => {
                try {
                    // 1. æŠ“æ³•äººè²·è³£è¶…
                    const res = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockInstitutionalInvestorsBuySell&data_id=${id}&start_date=${startDate}&token=${FINMIND_TOKEN}`);
                    const json = await res.json();
                    const data = json.data || [];
                    
                    if(data.length < 3) return null;

                    const last3 = data.slice(-3);
                    // æª¢æŸ¥æ˜¯å¦é€£è²· 3 å¤©
                    const isConsecutiveBuy = last3.every(d => d.Foreign_Investor_buy_sell > 0);
                    const totalBuy = last3.reduce((sum, d) => sum + d.Foreign_Investor_buy_sell, 0);

                    if(isConsecutiveBuy && totalBuy > 1000000) { // é€£è²·ä¸”å¤§æ–¼ 1000 å¼µ (1000è‚¡/å¼µ * 1000)
                         // 2. è£œæŠ“ç¾åƒ¹
                        const quote = await fetchFugleQuote(id);
                        return {
                            id: id,
                            name: quote.name || id,
                            totalBuy: Math.round(totalBuy / 1000), // è½‰æˆå¼µæ•¸
                            price: quote.lastPrice,
                            days: 3 // ç°¡å–®æ¨™ç¤ºé€£è²·å¤©æ•¸
                        };
                    }
                } catch(e) { console.error(id, e); }
                return null;
            });

            const rawResults = await Promise.all(promises);
            results = rawResults.filter(r => r !== null);
            
            // æ’åºï¼šè²·è¶…å¼µæ•¸å¤šåˆ°å°‘
            results.sort((a, b) => b.totalBuy - a.totalBuy);

            tbody.innerHTML = '';
            if(results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-500">ä»Šæ—¥æƒæç„¡ç¬¦åˆã€Œå¤–è³‡é€£è²·ã€æ¨™çš„</td></tr>';
                return;
            }

            results.forEach(r => {
                const row = `
                    <tr class="hover:bg-pink-900/20 cursor-pointer border-b border-slate-700" onclick="analyzeStock('${r.id}')">
                        <td class="px-4 py-3 font-bold text-white">${r.name} <span class="text-[10px] text-slate-500 block">${r.id}</span></td>
                        <td class="px-4 py-3 text-right text-profit font-mono">+${r.totalBuy.toLocaleString()}</td>
                        <td class="px-4 py-3 text-right text-pink-300">ğŸ”¥ ${r.days}å¤©</td>
                        <td class="px-4 py-3 text-right text-white">${r.price}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="event.stopPropagation(); analyzeStock('${r.id}')" class="text-xs bg-cyan-900 text-cyan-300 px-2 py-1 rounded">åˆ†æ</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // ğŸ› ï¸ æ ¸å¿ƒåˆ†æ
        async function analyzeStock(inputId = null) {
            const stockId = inputId || document.getElementById('stockInput').value.trim();
            if (!stockId) return alert("è«‹è¼¸å…¥ä»£ç¢¼");

            const btn = document.querySelector('button[onclick="analyzeStock()"]');
            if(btn) btn.innerText = "...";

            try {
                const [fugleData, historyData] = await Promise.all([
                    fetchFugleQuote(stockId),
                    fetchFinMindHistory(stockId)
                ]);

                let buyPoint = 0, techMsg = "æ•¸æ“šä¸è¶³", score = 50, chipMsg = "ä¸­ç«‹";

                if (historyData.length >= 5) {
                    const lows = historyData.slice(-5).map(d => d.min);
                    buyPoint = Math.min(...lows);
                    const ma5 = historyData.slice(-5).reduce((s, d) => s + d.close, 0) / 5;
                    if (fugleData.lastPrice > ma5) { score += 20; techMsg = "å¤šé ­æ’åˆ—"; }
                    else { score -= 10; techMsg = "çŸ­ç·šå›æª”"; }
                } else {
                    buyPoint = fugleData.lastPrice * 0.95;
                }

                currentStock = { id: stockId, name: fugleData.name, price: fugleData.lastPrice, buyPoint: buyPoint, score: score };
                updateAnalysisUI(currentStock, fugleData, techMsg, chipMsg);

            } catch (e) { alert("åˆ†æå¤±æ•—: " + e.message); } 
            finally { if(btn) btn.innerText = "åˆ†æ"; }
        }

        // ğŸ”„ æ›´æ–°è§€å¯Ÿæ¸…å–®
        async function refreshWatchlist() {
            const tbody = document.getElementById('watchlistBody');
            tbody.innerHTML = '';
            
            for (const id of WATCH_LIST_IDS) {
                try {
                    const quote = await fetchFugleQuote(id);
                    const history = await fetchFinMindHistory(id);
                    let buyPoint = quote.lastPrice * 0.9;
                    if(history.length >= 5) buyPoint = Math.min(...history.slice(-5).map(d => d.min));
                    
                    const diff = ((quote.lastPrice - buyPoint) / buyPoint * 100).toFixed(1);
                    const diffClass = diff < 2 ? 'text-profit animate-pulse' : 'text-slate-400';
                    
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-700 cursor-pointer" onclick="analyzeStock('${id}')">
                            <td class="px-2 py-2 font-bold text-white">${quote.name}</td>
                            <td class="px-2 py-2 text-right text-slate-300">${quote.lastPrice}</td>
                            <td class="px-2 py-2 text-right font-mono buy-point">${buyPoint.toFixed(1)}</td>
                            <td class="px-2 py-2 text-right text-xs ${diffClass}">${diff}%</td>
                        </tr>
                    `;
                } catch(e){}
            }
        }

        async function fetchFugleQuote(id) {
            const res = await fetch(`https://api.fugle.tw/marketdata/v1.0/stock/intraday/quote/${id}`, { headers: { "X-API-KEY": FUGLE_KEY } });
            return await res.json();
        }

        async function fetchFinMindHistory(id) {
            const startDate = new Date(Date.now() - 20 * 86400000).toISOString().split('T')[0];
            const res = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=${startDate}&token=${FINMIND_TOKEN}`);
            const json = await res.json();
            return json.data || [];
        }

        function updateAnalysisUI(stock, fugle, techMsg, chipMsg) {
            document.getElementById('analysisResult').classList.remove('hidden');
            document.getElementById('stockNameDisplay').innerText = `${stock.name} (${stock.id})`;
            const color = fugle.change >= 0 ? 'text-profit' : 'text-loss';
            document.getElementById('currentPrice').innerText = stock.price;
            document.getElementById('currentPrice').className = `text-4xl font-bold ${color}`;
            document.getElementById('priceChange').innerText = `${fugle.change} (${(fugle.changePercent*100).toFixed(2)}%)`;
            document.getElementById('priceChange').className = `text-base font-bold ${color}`;
            
            const diff = ((stock.price - stock.buyPoint) / stock.buyPoint * 100).toFixed(1);
            document.getElementById('recommendBuy').innerText = stock.buyPoint.toFixed(1);
            document.getElementById('diffText').innerText = `è·ç¾åƒ¹ ${diff}%`;
            
            document.getElementById('aiScore').innerText = stock.score;
            document.getElementById('scoreBar').style.width = `${stock.score}%`;
            document.getElementById('techStatus').innerText = techMsg;
            document.getElementById('chipStatus').innerText = chipMsg;
        }

        function addToPortfolio() {
            if (!currentStock) return;
            const qty = prompt("è¼¸å…¥æŒæœ‰å¼µæ•¸:", "1");
            if(!qty) return;
            portfolio.push({ id: currentStock.id, name: currentStock.name, cost: currentStock.price, qty: parseFloat(qty), curr: currentStock.price });
            saveAndRender();
        }

        function renderPortfolio() {
            const tbody = document.getElementById('portfolioBody');
            let totalPnL = 0;
            tbody.innerHTML = '';
            portfolio.forEach((p, i) => {
                const profit = (p.curr - p.cost) * p.qty * 1000;
                totalPnL += profit;
                const color = profit >= 0 ? 'text-profit' : 'text-loss';
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-800/50">
                        <td class="px-4 py-3 font-bold text-white">${p.name}</td>
                        <td class="px-4 py-3 text-right">${p.cost}</td>
                        <td class="px-4 py-3 text-right text-white">${p.curr}</td>
                        <td class="px-4 py-3 text-right">${p.qty}</td>
                        <td class="px-4 py-3 text-right font-bold ${color}">${Math.round(profit)}</td>
                        <td class="px-4 py-3 text-center"><button onclick="removeP(${i})" class="text-red-400">âœ•</button></td>
                    </tr>
                `;
            });
            const t = document.getElementById('totalProfit');
            t.innerText = Math.round(totalPnL).toLocaleString();
            t.className = `text-2xl font-bold ${totalPnL >= 0 ? 'text-profit' : 'text-loss'}`;
        }
        function removeP(i) { portfolio.splice(i, 1); saveAndRender(); }
        function saveAndRender() { localStorage.setItem('pro_portfolio_v3', JSON.stringify(portfolio)); renderPortfolio(); }
        async function updatePortfolioPrices() {
            for(let p of portfolio) { try { const q = await fetchFugleQuote(p.id); if(q.lastPrice) p.curr = q.lastPrice; } catch(e){} }
            saveAndRender();
            document.getElementById('updateTime').innerText = `æ›´æ–°æ–¼ ${new Date().toLocaleTimeString()}`;
        }
    </script>
</body>
</html>
