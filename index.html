<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡æ™ºæ…§åˆ†æèˆ‡æ“ç›¤ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Microsoft JhengHei', sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; }
        .input-field { background-color: #0f172a; border: 1px solid #475569; color: white; }
        .btn-primary { background-color: #06b6d4; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #0891b2; }
        .text-profit { color: #ef4444; } /* å°è‚¡ç´…æ¼² */
        .text-loss { color: #22c55e; }   /* å°è‚¡ç¶ è·Œ */
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- é ‚éƒ¨å°èˆª -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-cyan-400">ğŸ“ˆ å°è‚¡æ™ºæ…§åˆ†æç³»çµ±</h1>
            <p class="text-slate-400 text-sm mt-1">Powered by FinMind API | Token å·²å•Ÿç”¨</p>
        </div>
        <div class="text-right">
            <div id="updateTime" class="text-xs text-slate-500">ç­‰å¾…æ›´æ–°...</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- å·¦å´ï¼šæŸ¥è©¢èˆ‡åˆ†æå€ -->
        <div class="lg:col-span-1 space-y-6">
            <!-- 1. è‚¡ç¥¨æŸ¥è©¢ -->
            <div class="card p-5">
                <h2 class="text-xl font-bold mb-4 border-l-4 border-cyan-400 pl-3">ğŸ” å€‹è‚¡å³æ™‚è¨ºæ–·</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="stockInput" placeholder="è¼¸å…¥ä»£ç¢¼ (å¦‚ 2330)" class="input-field flex-1 px-4 py-2 rounded-lg focus:outline-none focus:border-cyan-400">
                    <button onclick="analyzeStock()" class="btn-primary px-6 py-2 rounded-lg font-bold">åˆ†æ</button>
                </div>
                
                <!-- åˆ†æçµæœé¡¯ç¤ºå€ -->
                <div id="analysisResult" class="hidden space-y-4">
                    <div class="flex justify-between items-end border-b border-slate-700 pb-3">
                        <div>
                            <h3 id="stockName" class="text-2xl font-bold text-white">å°ç©é›» (2330)</h3>
                            <span id="stockDate" class="text-xs text-slate-400">2025-11-27</span>
                        </div>
                        <div class="text-right">
                            <div id="currentPrice" class="text-3xl font-bold text-profit">1030.0</div>
                            <div id="priceChange" class="text-sm font-bold text-profit">+5.0 (0.5%)</div>
                        </div>
                    </div>

                    <!-- æ™ºèƒ½è©•åˆ† -->
                    <div class="bg-slate-800 rounded-lg p-4">
                        <div class="flex justify-between mb-2">
                            <span class="text-slate-400">AI ç¶œåˆæ¨è–¦åº¦</span>
                            <span id="aiScore" class="font-bold text-yellow-400">è¨ˆç®—ä¸­...</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2.5 mb-1">
                            <div id="scoreBar" class="bg-yellow-400 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="aiComment" class="text-xs text-slate-400 mt-2">ç­‰å¾…åˆ†ææ•¸æ“š...</p>
                    </div>

                    <!-- æ•¸æ“šçŸ©é™£ -->
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-slate-800 p-3 rounded">
                            <div class="text-slate-400 text-xs">è¿‘5æ—¥æœ€ä½ (æ”¯æ’åƒè€ƒ)</div>
                            <div id="low5Days" class="text-lg font-mono text-white">--</div>
                        </div>
                        <div class="bg-slate-800 p-3 rounded">
                            <div class="text-slate-400 text-xs">å¤–è³‡è¿‘3æ—¥å‹•å‘</div>
                            <div id="foreignTrend" class="text-lg font-mono text-white">--</div>
                        </div>
                    </div>

                    <!-- å‹•ä½œæŒ‰éˆ• -->
                    <button onclick="addToPortfolio()" class="w-full border border-cyan-400 text-cyan-400 hover:bg-cyan-900/30 py-2 rounded-lg mt-2 transition">
                        + åŠ å…¥æŒå€‰ç›£æ§
                    </button>
                </div>
            </div>

            <!-- 2. å¸‚å ´è‡ªå‹•æƒæ (æ¨è–¦åå–®) -->
            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-green-400 pl-3">âš¡ å¸‚å ´è§€å¯Ÿåå–®</h2>
                    <button onclick="scanMarket()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-slate-300">ğŸ”„ æƒæ</button>
                </div>
                <div class="overflow-y-auto max-h-64">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800 sticky top-0">
                            <tr>
                                <th class="px-3 py-2">ä»£ç¢¼</th>
                                <th class="px-3 py-2">ç¾åƒ¹</th>
                                <th class="px-3 py-2">è©•åˆ†</th>
                                <th class="px-3 py-2">ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="scannerTableBody" class="divide-y divide-slate-700">
                            <tr><td colspan="4" class="text-center py-4 text-slate-500">é»æ“Šæƒæä»¥ç²å–æ¨è–¦...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šæŒå€‰ç®¡ç† -->
        <div class="lg:col-span-2">
            <div class="card p-5 h-full">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold border-l-4 border-purple-400 pl-3">ğŸ’¼ æˆ‘çš„æŒå€‰èˆ‡æç›Š</h2>
                    <div class="text-right">
                        <span class="text-sm text-slate-400">ç¸½æç›Š: </span>
                        <span id="totalProfit" class="text-xl font-bold text-white">0</span>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800/50">
                            <tr>
                                <th class="px-4 py-3">è‚¡ç¥¨</th>
                                <th class="px-4 py-3">æˆæœ¬å‡åƒ¹</th>
                                <th class="px-4 py-3">ç¾åƒ¹</th>
                                <th class="px-4 py-3">åº«å­˜</th>
                                <th class="px-4 py-3">æç›Š</th>
                                <th class="px-4 py-3">æ”¯æ’(åœæ)</th>
                                <th class="px-4 py-3">å£“åŠ›(åœåˆ©)</th>
                                <th class="px-4 py-3">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="portfolioBody" class="divide-y divide-slate-700">
                            <!-- æŒå€‰åˆ—è¡¨å°‡æ¸²æŸ“æ–¼æ­¤ -->
                        </tbody>
                    </table>
                </div>
                
                <div id="emptyState" class="text-center py-10 text-slate-500">
                    <p>å°šç„¡æŒå€‰æ•¸æ“šï¼Œè«‹å¾å·¦å´åˆ†æå¾ŒåŠ å…¥</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript é‚è¼¯æ ¸å¿ƒ -->
    <script>
        // ğŸ” API è¨­å®š
        const API_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNS0xMS0yNyAxMjoyOToyOSIsInVzZXJfaWQiOiJMSU5QRyIsImlwIjoiMS4xNzAuMTE0LjIwIn0.SyyVMOX2eF6uNVO3EZpkRylFrQqFFXjH1PJcM5oFQt0";
        const BASE_URL = "https://api.finmindtrade.com/api/v4/data";

        // ç‹€æ…‹ç®¡ç†
        let currentAnalysis = null;
        let portfolio = JSON.parse(localStorage.getItem('tw_stock_portfolio')) || [];
        
        // é è¨­æƒææ¸…å–® (ç†±é–€æ¬Šå€¼è‚¡)
        const WATCHLIST = ['2330', '2317', '2454', '2308', '2881', '2603', '2382', '3037', '3231', '6669'];

        // åˆå§‹åŒ–
        window.onload = () => {
            renderPortfolio();
            document.getElementById('updateTime').innerText = `æœ€å¾Œæ›´æ–°: ${new Date().toLocaleString()}`;
        };

        // ğŸ› ï¸ æ ¸å¿ƒåŠŸèƒ½ï¼šåˆ†æå€‹è‚¡
        async function analyzeStock(stockIdInput = null) {
            const stockId = stockIdInput || document.getElementById('stockInput').value.trim();
            if (!stockId) return alert("è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼");

            const btn = document.querySelector('button[onclick="analyzeStock()"]');
            if(btn) btn.innerText = "åˆ†æä¸­...";

            try {
                // è¨­å®šæ™‚é–“ç¯„åœ (å–è¿‘ 30 å¤©ä»¥è¨ˆç®—å‡ç·šå’Œä½é»)
                const endDate = new Date().toISOString().split('T')[0];
                const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                // 1. ä¸¦è¡ŒæŠ“å– åƒ¹æ ¼ & ä¸‰å¤§æ³•äºº & åŸºæœ¬é¢(PER)
                const [priceRes, chipRes, perRes] = await Promise.all([
                    fetch(`${BASE_URL}?dataset=TaiwanStockPrice&data_id=${stockId}&start_date=${startDate}&token=${API_TOKEN}`),
                    fetch(`${BASE_URL}?dataset=TaiwanStockInstitutionalInvestorsBuySell&data_id=${stockId}&start_date=${startDate}&token=${API_TOKEN}`),
                    fetch(`${BASE_URL}?dataset=TaiwanStockPER&data_id=${stockId}&start_date=${startDate}&token=${API_TOKEN}`)
                ]);

                const priceData = (await priceRes.json()).data;
                const chipData = (await chipRes.json()).data;
                const perData = (await perRes.json()).data;

                if (!priceData || priceData.length === 0) throw new Error("æŸ¥ç„¡è³‡æ–™æˆ–ä»£ç¢¼éŒ¯èª¤");

                // 2. æ•¸æ“šè™•ç†
                const latest = priceData[priceData.length - 1];
                const prev = priceData[priceData.length - 2];
                
                // è¨ˆç®— 5 æ—¥æœ€ä½
                const last5Days = priceData.slice(-5);
                const low5 = Math.min(...last5Days.map(d => d.min));
                
                // è¨ˆç®— 5 æ—¥å‡ç·š (MA5)
                const ma5 = last5Days.reduce((sum, d) => sum + d.close, 0) / last5Days.length;

                // è¨ˆç®—å¤–è³‡è¿‘ 3 æ—¥è²·è³£è¶…
                const last3Chips = chipData.slice(-3);
                const foreignSum = last3Chips.reduce((sum, d) => sum + (d.Foreign_Investor_buy_sell || 0), 0);
                
                // å–å¾—æœ€æ–°æœ¬ç›Šæ¯”
                const latestPER = perData.length > 0 ? perData[perData.length - 1].PER : 0;

                // 3. æ™ºèƒ½è©•åˆ†é‚è¼¯ (0-100åˆ†)
                let score = 50; // åŸºç¤åˆ†
                let reasons = [];

                if (latest.close > ma5) { score += 15; reasons.push("ç«™ä¸Š5æ—¥å‡ç·š"); }
                else { score -= 10; reasons.push("è·Œç ´5æ—¥ç·š"); }

                if (foreignSum > 0) { score += 20; reasons.push("å¤–è³‡è¿‘3æ—¥è²·è¶…"); }
                else { score -= 15; reasons.push("å¤–è³‡è¿‘3æ—¥è³£è¶…"); }

                if (latestPER > 0 && latestPER < 15) { score += 10; reasons.push("æœ¬ç›Šæ¯”ä½ä¼°"); }
                
                if (latest.close <= low5 * 1.02) { score += 10; reasons.push("æ¥è¿‘è¿‘5æ—¥ä½é»(æ”¯æ’)"); }

                // 4. æ›´æ–° UI
                updateAnalysisUI({
                    id: stockId,
                    name: latest.stock_id, // API v4 é€™è£¡åªå›å‚³ IDï¼Œå¯¦éš›åç¨±éœ€å¦æŠ“æˆ–å¿½ç•¥
                    date: latest.date,
                    price: latest.close,
                    change: latest.close - prev.close,
                    pctChange: (latest.close - prev.close) / prev.close * 100,
                    low5: low5,
                    foreignTrend: foreignSum,
                    score: Math.min(100, Math.max(0, score)), // é™åˆ¶ 0-100
                    reasons: reasons
                });

            } catch (err) {
                console.error(err);
                alert("åˆ†æå¤±æ•—ï¼š" + err.message);
            } finally {
                if(btn) btn.innerText = "åˆ†æ";
            }
        }

        function updateAnalysisUI(data) {
            currentAnalysis = data; // æš«å­˜ä¾›åŠ å…¥æŒå€‰ç”¨
            
            const container = document.getElementById('analysisResult');
            container.classList.remove('hidden');

            // åŸºæœ¬è³‡æ–™
            document.getElementById('stockName').innerText = `${data.id}`;
            document.getElementById('stockDate').innerText = data.date;
            
            // åƒ¹æ ¼é¡è‰²
            const priceEl = document.getElementById('currentPrice');
            const changeEl = document.getElementById('priceChange');
            priceEl.innerText = data.price.toFixed(1);
            changeEl.innerText = `${data.change > 0 ? 'â–²' : 'â–¼'} ${Math.abs(data.change).toFixed(1)} (${Math.abs(data.pctChange).toFixed(2)}%)`;
            
            const colorClass = data.change >= 0 ? 'text-profit' : 'text-loss';
            priceEl.className = `text-3xl font-bold ${colorClass}`;
            changeEl.className = `text-sm font-bold ${colorClass}`;

            // è©•åˆ†
            document.getElementById('aiScore').innerText = data.score;
            document.getElementById('scoreBar').style.width = `${data.score}%`;
            
            let comment = "";
            if (data.score >= 80) comment = "ğŸš€ å¼·åŠ›æ¨è–¦ï¼šç±Œç¢¼èˆ‡æŠ€è¡“é¢é›™å¼·";
            else if (data.score >= 60) comment = "ğŸ‘€ å€¼å¾—è§€å¯Ÿï¼šåŸºæœ¬é¢è‰¯å¥½ï¼Œç­‰å¾…è²·é»";
            else comment = "âš ï¸ é¢¨éšªè¼ƒé«˜ï¼šå»ºè­°è§€æœ›ï¼Œç­‰å¾…æ­¢è·Œ";
            document.getElementById('aiComment').innerText = `${comment} (${data.reasons.join(', ')})`;
            
            // æ•¸æ“šçŸ©é™£
            document.getElementById('low5Days').innerText = data.low5;
            document.getElementById('foreignTrend').innerText = (data.foreignTrend / 1000).toFixed(1) + " å¼µ";
            document.getElementById('foreignTrend').className = `text-lg font-mono ${data.foreignTrend > 0 ? 'text-profit' : 'text-loss'}`;
        }

        // ğŸ› ï¸ æ ¸å¿ƒåŠŸèƒ½ï¼šåŠ å…¥æŒå€‰
        function addToPortfolio() {
            if (!currentAnalysis) return;
            
            const qty = prompt(`è«‹è¼¸å…¥ ${currentAnalysis.id} æŒæœ‰å¼µæ•¸ (ä¾‹å¦‚ 1):`, "1");
            if (!qty) return;
            
            const cost = prompt(`è«‹è¼¸å…¥è²·å…¥æˆæœ¬åƒ¹ (é è¨­ç¾åƒ¹):`, currentAnalysis.price);
            
            const newItem = {
                id: currentAnalysis.id,
                cost: parseFloat(cost || currentAnalysis.price),
                qty: parseFloat(qty),
                curr: currentAnalysis.price, // åˆå§‹ç¾åƒ¹
                low5: currentAnalysis.low5
            };
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œè‹¥æœ‰å‰‡æ›´æ–°
            const existingIdx = portfolio.findIndex(p => p.id === newItem.id);
            if (existingIdx >= 0) {
                portfolio[existingIdx] = newItem;
            } else {
                portfolio.push(newItem);
            }
            
            saveAndRender();
        }

        // ğŸ› ï¸ æ ¸å¿ƒåŠŸèƒ½ï¼šæ¸²æŸ“æŒå€‰åˆ—è¡¨
        function renderPortfolio() {
            const tbody = document.getElementById('portfolioBody');
            const empty = document.getElementById('emptyState');
            let totalPnL = 0;

            tbody.innerHTML = '';

            if (portfolio.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            portfolio.forEach((item, index) => {
                // è¨ˆç®—æç›Š
                const profit = (item.curr - item.cost) * item.qty * 1000;
                const profitClass = profit >= 0 ? 'text-profit' : 'text-loss';
                totalPnL += profit;

                // è‡ªå‹•è¨ˆç®—æ”¯æ’èˆ‡å£“åŠ›
                const support = (item.cost * 0.95).toFixed(1); // åœæ -5%
                const resistance = (item.cost * 1.10).toFixed(1); // åœåˆ© +10%

                const row = `
                    <tr class="hover:bg-slate-800/50 transition">
                        <td class="px-4 py-3 font-bold text-white">${item.id}</td>
                        <td class="px-4 py-3">${item.cost}</td>
                        <td class="px-4 py-3 text-white">${item.curr}</td>
                        <td class="px-4 py-3">${item.qty} å¼µ</td>
                        <td class="px-4 py-3 font-bold ${profitClass}">${profit > 0 ? '+' : ''}${Math.round(profit).toLocaleString()}</td>
                        <td class="px-4 py-3 text-slate-400">${support} <span class="text-xs text-slate-600">(-5%)</span></td>
                        <td class="px-4 py-3 text-cyan-400">${resistance} <span class="text-xs text-slate-600">(+10%)</span></td>
                        <td class="px-4 py-3">
                            <button onclick="removePortfolio(${index})" class="text-xs bg-red-900/50 text-red-400 px-2 py-1 rounded hover:bg-red-900">åˆªé™¤</button>
                            <button onclick="analyzeStock('${item.id}')" class="text-xs bg-cyan-900/50 text-cyan-400 px-2 py-1 rounded hover:bg-cyan-900 ml-1">æ›´æ–°</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // æ›´æ–°ç¸½æç›Š
            const totalEl = document.getElementById('totalProfit');
            totalEl.innerText = `${totalPnL > 0 ? '+' : ''}${Math.round(totalPnL).toLocaleString()}`;
            totalEl.className = `text-xl font-bold ${totalPnL >= 0 ? 'text-profit' : 'text-loss'}`;
        }

        function removePortfolio(index) {
            if(confirm("ç¢ºå®šç§»é™¤æ­¤æŒå€‰å—ï¼Ÿ")) {
                portfolio.splice(index, 1);
                saveAndRender();
            }
        }

        function saveAndRender() {
            localStorage.setItem('tw_stock_portfolio', JSON.stringify(portfolio));
            renderPortfolio();
        }

        // ğŸ› ï¸ æ ¸å¿ƒåŠŸèƒ½ï¼šå¸‚å ´æƒæ
        async function scanMarket() {
            const tbody = document.getElementById('scannerTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-cyan-400 animate-pulse">æ­£åœ¨æƒæå¸‚å ´æ•¸æ“š...</td></tr>';
            
            let results = [];

            // é™åˆ¶æƒææ•¸é‡ä»¥å…ç€è¦½å™¨å¡é “
            for (const stockId of WATCHLIST) {
                try {
                    const endDate = new Date().toISOString().split('T')[0];
                    const startDate = new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    
                    // ç°¡å–®æƒæï¼šåªçœ‹åƒ¹æ ¼å’Œå‡ç·š
                    const res = await fetch(`${BASE_URL}?dataset=TaiwanStockPrice&data_id=${stockId}&start_date=${startDate}&token=${API_TOKEN}`);
                    const json = await res.json();
                    const data = json.data;
                    
                    if(data && data.length > 0) {
                        const latest = data[data.length - 1];
                        const ma5 = data.reduce((s, d) => s + d.close, 0) / data.length;
                        
                        // ç°¡æ˜“è©•åˆ†
                        let score = 50;
                        if(latest.close > ma5) score += 20; // ç«™ä¸Šå‡ç·š
                        if(latest.Trading_Volume > 10000000) score += 10; // é‡å¤§
                        
                        results.push({
                            id: stockId,
                            price: latest.close,
                            score: score
                        });
                    }
                } catch (e) { console.error(e); }
            }

            // æ’åºä¸¦æ¸²æŸ“
            results.sort((a, b) => b.score - a.score);
            
            tbody.innerHTML = '';
            results.forEach(item => {
                let badge = item.score >= 70 ? '<span class="bg-red-900 text-red-300 text-xs px-2 py-0.5 rounded">å¼·å‹¢</span>' : 
                            item.score >= 50 ? '<span class="bg-yellow-900 text-yellow-300 text-xs px-2 py-0.5 rounded">è§€å¯Ÿ</span>' :
                            '<span class="bg-slate-700 text-slate-400 text-xs px-2 py-0.5 rounded">å¼±å‹¢</span>';
                            
                const row = `
                    <tr class="hover:bg-slate-700 cursor-pointer" onclick="analyzeStock('${item.id}')">
                        <td class="px-3 py-2 font-bold text-white">${item.id}</td>
                        <td class="px-3 py-2">${item.price}</td>
                        <td class="px-3 py-2 font-mono text-yellow-400">${item.score}</td>
                        <td class="px-3 py-2">${badge}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // è‡ªå‹•è¼‰å…¥ï¼šå¦‚æœæœ‰æŒå€‰ï¼Œè‡ªå‹•æ›´æ–°ä¸€æ¬¡æœ€æ–°åƒ¹
        if(portfolio.length > 0) {
            // é€™è£¡å¯ä»¥å¯¦ä½œä¸€å€‹ batch updateï¼Œç›®å‰å…ˆç°¡å–®è·³éï¼Œé¿å… API å‘¼å«éå¤š
            console.log("æŒå€‰è¼‰å…¥å®Œæˆ");
        }
    </script>
</body>
</html>
