<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡é›™å¼•æ“å„€è¡¨æ¿ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Microsoft JhengHei', sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; }
        .input-field { background-color: #0f172a; border: 1px solid #475569; color: white; }
        .btn-primary { background-color: #06b6d4; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #0891b2; }
        .text-profit { color: #ef4444; } 
        .text-loss { color: #22c55e; }
        .buy-point { color: #facc15; font-weight: bold; }
        .industry-header { background: #334155; color: #94a3b8; font-size: 0.75rem; font-weight: bold; padding: 4px 12px; }
        
        .kdj-tag { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; width: 60px; text-align: center; }
        .kdj-overbought { background-color: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid #ef4444; }
        .kdj-oversold { background-color: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid #22c55e; }
        .kdj-neutral { background-color: rgba(148, 163, 184, 0.2); color: #cbd5e1; border: 1px solid #64748b; }
        
        .main-force-tag { background: linear-gradient(90deg, #f59e0b, #d97706); color: white; font-size: 0.65rem; padding: 1px 4px; border-radius: 2px; margin-left: 4px; font-weight: bold; animation: pulse 2s infinite; }
        
        .buy-icon { font-size: 1rem; animation: bounce 1s infinite; display: inline-block; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        
        .order-book-row { font-family: monospace; font-size: 0.85rem; }
        .bid-bar { background-color: rgba(239, 68, 68, 0.2); height: 100%; border-radius: 2px; transition: width 0.3s; }
        .ask-bar { background-color: rgba(34, 197, 94, 0.2); height: 100%; border-radius: 2px; transition: width 0.3s; }
        
        .modal-overlay { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(2px); }
        #alertModal { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="p-4 md:p-8 relative">

    <!-- è‡ªå®šç¾©å½ˆçª— (åŠ å…¥æŒå€‰) -->
    <div id="addPortfolioModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay">
        <div class="bg-slate-800 rounded-lg border border-slate-600 p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4">ğŸ“¥ åŠ å…¥æŒå€‰</h3>
            <div class="mb-4">
                <label class="block text-slate-400 text-sm mb-1">è‚¡ç¥¨åç¨±</label>
                <input type="text" id="modalStockName" class="w-full bg-slate-700 text-white px-3 py-2 rounded border border-slate-600" disabled>
            </div>
            <div class="mb-4">
                <label class="block text-slate-400 text-sm mb-1">æŒæœ‰å¼µæ•¸</label>
                <input type="number" id="modalQty" class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-cyan-500 focus:outline-none" value="1">
            </div>
            <div class="mb-6">
                <label class="block text-slate-400 text-sm mb-1">è²·å…¥æˆæœ¬åƒ¹</label>
                <input type="number" id="modalCost" class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-cyan-500 focus:outline-none">
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-slate-300 hover:text-white">å–æ¶ˆ</button>
                <button onclick="confirmAddPortfolio()" class="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold">ç¢ºèªåŠ å…¥</button>
            </div>
        </div>
    </div>

    <!-- ğŸ”” å¤§å–®è­¦ç¤ºå½ˆçª— -->
    <div id="bigOrderAlert" class="fixed inset-0 z-[60] hidden flex items-center justify-center pointer-events-none">
        <div id="alertModal" class="bg-gradient-to-b from-slate-700 to-slate-900 rounded-xl border-2 border-yellow-500 p-0 w-80 shadow-2xl pointer-events-auto overflow-hidden">
            <div class="bg-gradient-to-r from-slate-800 to-slate-700 p-3 border-b border-slate-600 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white flex items-center"><span class="mr-2 text-yellow-400">ğŸ””</span> æç¤ºè¨Šæ¯</h3>
                <button onclick="closeAlert()" class="text-slate-400 hover:text-white text-xl">Ã—</button>
            </div>
            <div class="p-6 text-center">
                <p id="alertTime" class="text-sm text-slate-400 mb-2">--:--</p>
                <h4 id="alertStock" class="text-2xl font-bold text-white mb-1">--</h4>
                <p class="text-lg text-slate-300">ç¾åƒ¹ <span id="alertPrice" class="text-profit font-bold">--</span></p>
                <div class="mt-4 bg-slate-800/50 rounded p-2 border border-slate-700">
                    <p class="text-yellow-400 font-bold text-xl">âš¡ å–®é‡ <span id="alertVol">--</span> å¼µ</p>
                    <p class="text-xs text-slate-500 mt-1">è¶…éè¨­å®šé–€æª» (100)</p>
                </div>
            </div>
            <div class="flex border-t border-slate-600">
                <button onclick="closeAlert()" class="flex-1 py-3 text-slate-300 hover:bg-slate-700 transition">å¿½ç•¥</button>
                <button onclick="closeAlert()" class="flex-1 py-3 text-cyan-400 font-bold hover:bg-slate-700 transition border-l border-slate-600">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-cyan-400">ğŸš€ å°è‚¡é›™å¼•æ“å„€è¡¨æ¿</h1>
            <p class="text-slate-400 text-sm mt-1">v5.1</p>
        </div>
        <div class="text-right">
            <div id="updateTime" class="text-xs text-slate-500">æ›´æ–°ä¸­...</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- å·¦å´ï¼šå€‹è‚¡è¨ºæ–· -->
        <div class="lg:col-span-1 space-y-6">
            <div class="card p-5">
                <h2 class="text-xl font-bold mb-4 border-l-4 border-cyan-400 pl-3">ğŸ” å€‹è‚¡è¨ºæ–·</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="stockInput" placeholder="è¼¸å…¥ä»£ç¢¼ (ä¾‹: 2330)" class="input-field flex-1 px-4 py-2 rounded-lg focus:outline-none focus:border-cyan-400">
                    <button onclick="analyzeStock()" class="btn-primary px-6 py-2 rounded-lg font-bold">åˆ†æ</button>
                </div>
                
                <div id="analysisResult" class="hidden space-y-4">
                    <div class="flex justify-between items-end border-b border-slate-700 pb-3">
                        <div>
                            <h3 id="stockNameDisplay" class="text-2xl font-bold text-white">--</h3>
                            <span id="kdjStatusBadge" class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">--</span>
                        </div>
                        <div class="text-right">
                            <div id="currentPrice" class="text-4xl font-bold text-white">--</div>
                            <div id="priceChange" class="text-base font-bold text-slate-400">--</div>
                        </div>
                    </div>

                    <!-- æœ€ä½³äº”æª” -->
                    <div class="bg-slate-900/50 p-2 rounded border border-slate-700 text-xs">
                        <div class="grid grid-cols-2 gap-4">
                            <div><div class="text-center text-slate-500 mb-1">å§”è²·é‡ / è²·åƒ¹</div><div id="bidTable" class="space-y-1"></div></div>
                            <div><div class="text-center text-slate-500 mb-1">è³£åƒ¹ / å§”è³£é‡</div><div id="askTable" class="space-y-1"></div></div>
                        </div>
                    </div>

                    <!-- KDJ & è²·é» -->
                    <div class="grid grid-cols-3 gap-2 text-center bg-slate-800 p-2 rounded border border-slate-700">
                        <div><div class="text-xs text-slate-500">Kå€¼</div><div id="kVal" class="font-mono font-bold text-white">--</div></div>
                        <div><div class="text-xs text-slate-500">Då€¼</div><div id="dVal" class="font-mono font-bold text-white">--</div></div>
                        <div><div class="text-xs text-slate-500">Jå€¼</div><div id="jVal" class="font-mono font-bold text-white">--</div></div>
                    </div>

                    <div class="bg-slate-800/80 p-3 rounded-lg border border-yellow-600/30 mt-2 flex justify-between items-center">
                        <div>
                            <div class="text-sm text-slate-400">ğŸ¯ å»ºè­°è²·é»</div>
                            <div id="recommendBuy" class="text-2xl font-mono text-yellow-400 font-bold">--</div>
                        </div>
                        <div class="text-right">
                            <div id="diffText" class="text-xs text-slate-400">è·ç¾åƒ¹ --%</div>
                            <div id="buySignalIcon" class="hidden text-2xl">ğŸ¯</div>
                        </div>
                    </div>
                    
                    <button onclick="openAddModal()" class="w-full bg-cyan-700 hover:bg-cyan-600 text-white py-3 rounded-lg mt-4 transition shadow-lg">
                        + åŠ å…¥æŒå€‰
                    </button>
                </div>
            </div>

            <!-- ğŸ“‹ è§€å¯Ÿè‚¡ç¥¨åå–® -->
            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-yellow-400 pl-3">ğŸ“‹ è§€å¯Ÿè‚¡ç¥¨åå–®</h2>
                    <button onclick="refreshWatchlist()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-slate-300">ğŸ”„</button>
                </div>
                <div class="overflow-x-auto h-[500px] pr-1">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800 sticky top-0 z-10">
                            <tr>
                                <th class="px-2 py-2">è‚¡å</th>
                                <th class="px-2 py-2 text-right">ç¾åƒ¹</th>
                                <th class="px-2 py-2 text-center">KDJ</th>
                                <th class="px-2 py-2 text-right">è²·é»</th>
                                <th class="px-2 py-2 text-center">è¨Šè™Ÿ</th>
                            </tr>
                        </thead>
                        <tbody id="watchlistBody" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šå¤§æˆ¶é›·é” & æŒå€‰ -->
        <div class="lg:col-span-2 space-y-6">
            
            <div class="card p-5 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-yellow-500/10 rounded-full blur-xl -mr-10 -mt-10 pointer-events-none"></div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-yellow-500 pl-3 flex items-center">
                        ğŸ“¡ å¤§æˆ¶é›·é” 
                        <span class="ml-2 text-xs bg-yellow-900 text-yellow-300 px-2 py-0.5 rounded animate-pulse">LIVE</span>
                    </h2>
                    <button onclick="scanBigOrders()" class="text-xs bg-yellow-900/50 hover:bg-yellow-900 text-white px-3 py-1 rounded border border-yellow-700">ğŸš€ æƒæ</button>
                </div>
                <div class="overflow-x-auto max-h-64 bg-black/20 rounded-lg border border-slate-700/50">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800 sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3">æ™‚é–“</th>
                                <th class="px-4 py-3">è‚¡ç¥¨</th>
                                <th class="px-4 py-3 text-right">å¤§å–®(å¼µ)</th>
                                <th class="px-4 py-3 text-right">æˆäº¤åƒ¹</th>
                                <th class="px-4 py-3">ä¸»åŠ›å‹•æ…‹</th>
                                <th class="px-4 py-3 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="bigOrderBody" class="divide-y divide-slate-700">
                            <tr><td colspan="6" class="text-center py-12 text-slate-500">ç­‰å¾…å¤§æˆ¶é€²å ´...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold border-l-4 border-purple-400 pl-3">ğŸ’¼ æŒå€‰æç›Š</h2>
                    <span id="totalProfit" class="text-2xl font-bold text-white">0</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800/80">
                            <tr>
                                <th class="px-4 py-3">è‚¡ç¥¨</th>
                                <th class="px-4 py-3 text-right">æˆæœ¬</th>
                                <th class="px-4 py-3 text-right">ç¾åƒ¹</th>
                                <th class="px-4 py-3 text-right">åº«å­˜</th>
                                <th class="px-4 py-3 text-right">æç›Š</th>
                                <th class="px-4 py-3 text-center">KDJè¨Šè™Ÿ</th>
                                <th class="px-4 py-3 text-center">åˆªé™¤</th>
                            </tr>
                        </thead>
                        <tbody id="portfolioBody" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

    <script>
        const FUGLE_KEY = "OGNiYzc2YmQtMzdjYS00NTJkLWI1ZGUtNjY1ODRhNTMwNTAxIDhlMTRiMDVkLTk0NzItNDUzMi05NjY2LTkzYjlhMTQ5NzBjMw==";
        const FINMIND_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNS0xMS0yNyAxMjoyOToyOSIsInVzZXJfaWQiOiJMSU5QRyIsImlwIjoiMS4xNzAuMTE0LjIwIn0.SyyVMOX2eF6uNVO3EZpkRylFrQqFFXjH1PJcM5oFQt0";

        const INDUSTRY_LIST = {
            'åŠå°é«”': ['2330', '2454', '2303', '3034'],
            'AIä¼ºæœå™¨': ['2382', '3231', '6669', '2356'],
            'é›»è…¦é€±é‚Š': ['2317', '2357', '2324'],
            'èˆªé‹': ['2603', '2609', '2615'],
            'é‡‘è': ['2881', '2882', '2891']
        };
        const SCAN_POOL = Object.values(INDUSTRY_LIST).flat();
        
        let currentStock = null;
        let portfolio = JSON.parse(localStorage.getItem('pro_portfolio_v3')) || [];
        let lastAlertTime = 0;

        window.onload = () => {
            renderPortfolio();
            refreshWatchlist();
            setInterval(updatePortfolioPrices, 30000);
            setInterval(scanBigOrders, 5000); 
        };

        // ğŸ› ï¸ æ ¸å¿ƒåˆ†æ
        async function analyzeStock(inputId = null) {
            const stockId = inputId || document.getElementById('stockInput').value.trim();
            if (!stockId) return alert("è«‹è¼¸å…¥ä»£ç¢¼");
            const btn = document.querySelector('button[onclick="analyzeStock()"]');
            if(btn) btn.innerText = "...";
            
            try {
                const fugleData = await fetchFugleQuote(stockId);
                if (!fugleData || !fugleData.lastPrice) throw new Error("Fugle å ±åƒ¹å¤±æ•—");

                let historyData = [];
                try { historyData = await fetchFinMindHistory(stockId); } catch (err) {}

                const kdj = calculateKDJ(historyData);
                let buyPoint = historyData.length >= 5 ? Math.min(...historyData.slice(-5).map(d => d.min)) : fugleData.lastPrice * 0.95;

                currentStock = { id: stockId, name: fugleData.name, price: fugleData.lastPrice, buyPoint: buyPoint, kdj: kdj };
                updateAnalysisUI(currentStock, fugleData);
                renderOrderBook(fugleData.bids, fugleData.asks);

            } catch (e) { console.error(e); alert("åˆ†æå¤±æ•—: " + e.message); } 
            finally { if(btn) btn.innerText = "åˆ†æ"; }
        }

        function renderOrderBook(bids, asks) {
            const bidEl = document.getElementById('bidTable');
            const askEl = document.getElementById('askTable');
            bidEl.innerHTML = ''; askEl.innerHTML = '';
            if (!bids || !asks) { bidEl.innerHTML = '<div class="text-center text-xs">ç„¡æ•¸æ“š</div>'; return; }
            bids.slice(0, 5).forEach(b => {
                bidEl.innerHTML += `<div class="flex justify-between items-center order-book-row relative"><div class="absolute right-0 top-0 bottom-0 bid-bar" style="width: ${Math.min(100, (b.volume/50)*100)}%"></div><span class="text-white z-
